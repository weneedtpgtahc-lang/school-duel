<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Virus vs Vaccine Duel</title>
<style>
  :root{
    --bg:#0e1117; --panel:#151a22; --line:#2a3242; --text:#e8eefc; --muted:#a9b4cf;
    --good:#26d07c; --bad:#ff5c5c; --chip:#20283a; --white:#fff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
  .hide{display:none!important}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .sp{justify-content:space-between}
  .pill{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:12px;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

  /* ===== LOBBY ===== */
  .lobbyWrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
  .lobbyCard{
    width:min(420px, 92vw);
    background:var(--white);
    color:#111;
    border-radius:18px;
    padding:22px;
    box-shadow:0 18px 60px rgba(0,0,0,.45);
    border:1px solid rgba(0,0,0,.08);
    display:flex;flex-direction:column;gap:14px;
  }
  .title{font-size:22px;font-weight:900;text-align:center}
  .subtitle{font-size:13px;color:#444;text-align:center;line-height:1.4}
  .divider{height:1px;background:#e5e7eb;margin:2px 0}
  .lbtn{
    width:100%; border:none; border-radius:12px; padding:13px 12px;
    font-weight:900; font-size:16px; cursor:pointer;
  }
  .lbtn.create{background:#2563eb;color:#fff}
  .lbtn.join{background:#10b981;color:#fff}
  .lbtn.start{background:#111;color:#fff}
  .lbtn.faction{background:#f3f4f6;color:#111}
  .lbtn:active{transform:translateY(1px)}
  .lin{
    width:100%; border:1px solid #d1d5db; border-radius:12px; padding:12px;
    text-align:center; font-size:15px; outline:none;
  }
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .status{font-size:12px;color:#374151;text-align:center}

  /* ===== GAME ===== */
  .app{max-width:1180px;margin:0 auto;padding:14px}
  .topbar{
    position:sticky;top:0;z-index:10;
    background:rgba(14,17,23,.92);backdrop-filter:blur(8px);
    border:1px solid var(--line);border-radius:16px;padding:10px 12px;margin-bottom:10px;
  }
  .btn{
    border:1px solid var(--line); background:linear-gradient(180deg,#1b2230,#141a24);
    color:var(--text); padding:10px 12px;border-radius:12px; font-weight:900; cursor:pointer;
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{border-color:#3a4a70;background:linear-gradient(180deg,#243151,#172137)}
  .btn.good{border-color:#1f6d4a;background:linear-gradient(180deg,#1f6d4a,#134634)}
  .btn:disabled{opacity:.45;cursor:not-allowed}

  .hpbar{width:160px;height:10px;border-radius:999px;background:#222;border:1px solid var(--line);overflow:hidden}
  .hpfill{height:100%;background:linear-gradient(90deg,#26d07c,#6ef3b1)}
  .hpfill.bad{background:linear-gradient(90deg,#ff5c5c,#ff9a9a)}
  select{
    background:#0f1420;border:1px solid var(--line);color:var(--text);
    padding:10px 12px;border-radius:12px;outline:none;
  }

  .panel{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:12px;margin:10px 0}
  .laneTitle{display:flex;align-items:center;justify-content:space-between;margin:0 0 6px}
  .laneTitle span{color:var(--muted);font-size:12px}

  /* ìƒëŒ€ í•„ë“œ: ëª¬ìŠ¤í„° 4ì¹¸ + PLAYER 1ì¹¸ = 5ì¹¸ */
  .field{display:grid;grid-template-columns:repeat(5,minmax(160px,1fr));gap:10px}
  @media (max-width: 860px){ .field{grid-template-columns:repeat(2,minmax(160px,1fr))} }

  .slot{
    position:relative;border:1px dashed #3a4660;border-radius:16px;background:linear-gradient(180deg,#101522,#0d111b);
    min-height:250px;overflow:hidden;
  }
  .slotHdr{
    position:absolute;left:8px;right:8px;top:8px;
    display:flex;justify-content:space-between;gap:6px;align-items:center;
    pointer-events:none;
  }
  .badge{padding:4px 8px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.08);font-size:12px;color:#cfe1ff}
  .badge.lock{color:#ffd0d0}
  .overlay{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.55);font-weight:900;font-size:16px;color:#fff;
  }

  .card{
    height:100%;display:flex;flex-direction:column;
    border:1px solid #263049;border-radius:16px;overflow:hidden;background:#0c111c;
    cursor:pointer;
  }
  .card.selected{outline:3px solid #fff}
  .thumb{width:100%;height:160px;object-fit:cover;background:#1a2333}
  .meta{padding:10px;display:flex;flex-direction:column;gap:8px}
  .name{font-weight:900;font-size:14px}
  .stats{display:flex;gap:8px;flex-wrap:wrap}
  .chip2{padding:4px 8px;border-radius:999px;background:#141d2e;border:1px solid #263049;font-size:12px;color:#cfe1ff}
  .chip2.mark{color:#d6ff8a}
  .fx{font-size:12px;color:var(--muted);line-height:1.35;min-height:30px}
  .emptyHint{height:100%;display:flex;align-items:center;justify-content:center;color:#5f6b84;font-weight:900}

  .hand{display:flex;gap:10px;overflow:auto;padding-bottom:6px;scroll-snap-type:x mandatory}
  .hcard{min-width:180px;scroll-snap-align:start}

  .toast{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:16px;max-width:min(680px, 92vw);
    background:rgba(0,0,0,.72);backdrop-filter:blur(6px);
    border:1px solid rgba(255,255,255,.14);color:#fff;
    padding:10px 12px;border-radius:999px;font-size:13px;
    z-index:60;
  }

  /* ===== RESULT OVERLAY ===== */
  .result{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.62);
    backdrop-filter:blur(6px);
    z-index:80;
  }
  .resultCard{
    width:min(420px, 92vw);
    background:#0c111c;
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    padding:18px;
    box-shadow:0 18px 60px rgba(0,0,0,.55);
    text-align:center;
  }
  .resultTitle{font-size:22px;font-weight:900;margin-bottom:6px}
  .resultSub{font-size:13px;color:#cbd5e1;line-height:1.5;margin-bottom:12px}
  .resultBtns{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
</style>
</head>

<body>

<!-- ===== LOBBY ===== -->
<div id="lobby" class="lobbyWrap">
  <div class="lobbyCard">
    <div class="title">Virus vs Vaccine Duel</div>
    <div class="subtitle">ë°©ì„ ë§Œë“¤ê±°ë‚˜ ì½”ë“œë¥¼ ì…ë ¥í•´ ì°¸ê°€ â†’ ì§„ì˜ ì„ íƒ â†’ í˜¸ìŠ¤íŠ¸ê°€ ì‹œì‘</div>
    <div class="divider"></div>

    <button id="create" class="lbtn create">ë°© ë§Œë“¤ê¸°</button>
    <input id="code" class="lin" placeholder="ë°© ì½”ë“œ ì…ë ¥" />
    <button id="join" class="lbtn join">ë°© ì°¸ê°€</button>

    <div class="divider"></div>

    <div class="grid2">
      <button id="virus" class="lbtn faction">ğŸ¦  ë°”ì´ëŸ¬ìŠ¤</button>
      <button id="vaccine" class="lbtn faction">ğŸ’‰ ë°±ì‹ </button>
    </div>

    <button id="start" class="lbtn start hide">ê²Œì„ ì‹œì‘ (í˜¸ìŠ¤íŠ¸)</button>

    <div class="status" id="lobbyStatus">ì°¸ê°€ 0/2 Â· ì§„ì˜ ì„ íƒ 0/2</div>
    <div class="status mono" id="lobbyInfo"></div>
  </div>
</div>

<!-- ===== GAME ===== -->
<div id="game" class="app hide">
  <div class="topbar">
    <div class="row sp">
      <div class="row">
        <span id="turnPill" class="pill">TURN -/-</span>
        <span id="youPill" class="pill">YOU</span>
        <span id="roomPill" class="pill mono">ROOM: -</span>
      </div>
      <div class="row">
        <div class="row" style="gap:8px">
          <span class="pill">HP</span>
          <div class="hpbar"><div id="hpFill" class="hpfill" style="width:100%"></div></div>
          <span id="hpText" class="pill">100</span>
        </div>
        <span id="manaPill" class="pill">MANA 0</span>
        <span id="actPill" class="pill">ACT 0/2</span>
        <span id="atkPill" class="pill">ATK 0/2</span>
        <button id="endTurn" class="btn primary">í„´ ì¢…ë£Œ</button>
      </div>
    </div>

    <div class="row sp" style="margin-top:8px">
      <div class="row">
        <button id="modeBuy" class="btn">ğŸ›’ êµ¬ë§¤ëª¨ë“œ</button>
        <button id="modeSummon" class="btn">ğŸ§¬ ì†Œí™˜ëª¨ë“œ</button>
        <button id="modeAttack" class="btn">âš”ï¸ ê³µê²©ëª¨ë“œ</button>
        <span id="helpPill" class="pill">êµ¬ë§¤â†’ì†Œí™˜â†’ê³µê²© ìˆœì„œ</span>
      </div>
      <div class="row">
        <select id="tierSel">
          <option value="low">í•˜ê¸‰(2)</option>
          <option value="mid">ì¤‘ê¸‰(5)</option>
          <option value="high">ìƒê¸‰(9)</option>
        </select>
        <button id="buy" class="btn good">êµ¬ë§¤</button>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="laneTitle"><strong>ìƒëŒ€ í•„ë“œ</strong>
      <span id="opInfo" class="pill">-</span>
    </div>
    <div id="opField" class="field"></div>
  </div>

  <div class="panel">
    <div class="laneTitle"><strong>ë‚´ í•„ë“œ</strong>
      <span id="myInfo" class="pill">í”¼ê°:0%</span>
    </div>
    <div id="myField" class="field"></div>
  </div>

  <div class="panel">
    <div class="laneTitle"><strong>ë‚´ ì†íŒ¨</strong><span id="handCount" class="pill">0</span></div>
    <div id="hand" class="hand"></div>
  </div>
</div>

<div id="toast" class="toast hide"></div>

<!-- ê²°ê³¼ ì˜¤ë²„ë ˆì´ -->
<div id="result" class="result hide">
  <div class="resultCard">
    <div id="resultTitle" class="resultTitle">ê²°ê³¼</div>
    <div id="resultSub" class="resultSub">-</div>
    <div class="resultBtns">
      <button id="restartBtn" class="btn primary">ìƒˆë¡œ í•˜ê¸°</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* âœ… Firebase ì„¤ì • */
const firebaseConfig = {
  apiKey: "AIzaSyBIZll4u_E6zHKyoJZqjCI6_P9cxhK1Shs",
  authDomain: "yanngok-9323a.firebaseapp.com",
  projectId: "yanngok-9323a",
  storageBucket: "yanngok-9323a.firebasestorage.app",
  messagingSenderId: "433037582784",
  appId: "1:433037582784:web:43d77ca2530126240a2825",
  measurementId: "G-M51E2S8PQF"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const $ = (id)=>document.getElementById(id);
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const rid=()=>Math.random().toString(36).slice(2,8).toUpperCase();
const uid=()=>Math.random().toString(36).slice(2,10);

const COST={low:2,mid:5,high:9};
const MAX_TURN=20; // 20í„´ ëë‚˜ë©´ ì¢…ë£Œ(21í„´ ì§„ì… ì‹œ)

/* ===== ì´ë¯¸ì§€ ê²½ë¡œ ===== */
const VIRUS_IMAGES = {
  low:  ["assets/virus/virus_low_1.png","assets/virus/virus_low_2.png","assets/virus/virus_low_3.png"],
  mid:  ["assets/virus/virus_mid_1.png","assets/virus/virus_mid_2.png","assets/virus/virus_mid_3.png"],
  high: ["assets/virus/virus_high_1.png","assets/virus/virus_high_2.png","assets/virus/virus_high_3.png"],
};
const VAX_IMAGES = {
  low:  ["assets/vaccine/vax_low_1.png","assets/vaccine/vax_low_2.png","assets/vaccine/vax_low_3.png"],
  mid:  ["assets/vaccine/vax_mid_1.png","assets/vaccine/vax_mid_2.png","assets/vaccine/vax_mid_3.png"],
  high: ["assets/vaccine/vax_high_1.png","assets/vaccine/vax_high_2.png","assets/vaccine/vax_high_3.png"],
};

const fallbackImg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='520' height='360'%3E%3Crect width='100%25' height='100%25' fill='%231a2333'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23cfe1ff' font-size='22'%3ENo Image%3C/text%3E%3C/svg%3E";

/* ===== ëª¬ìŠ¤í„° ë°ì´í„°(ìµœì¢…) =====
   í‘œì‹: ëª¬ìŠ¤í„°ì—ê²Œë§Œ / ìœ ë¬´ë§Œ / 2í„´
   - virus: applyMark(í‘œì‹ ë¶€ì—¬), bonusVsMarked(í‘œì‹ ëŒ€ìƒ ì¶”ë€)
   - vaccine: healOn("end"|"hurt"|"attack"|"startAll"|"endAll"), healAmount
   íš¨ê³¼ ì—†ëŠ” ì¹´ë“œ: effect ë¹ˆ ë¬¸ìì—´ -> UIì—ì„œ "íš¨ê³¼ ì—†ìŒ" í‘œì‹œ
*/
const MONSTERS = {
  virus:{
    low:[
      {id:"vL1",name:"ì¹¨íˆ¬ í¬ì",tier:"low",atk:7,hp:18,applyMark:true, bonusVsMarked:0, effect:"ëª¬ìŠ¤í„° ê³µê²© ì‹œ ëŒ€ìƒì—ê²Œ í‘œì‹(2í„´) ë¶€ì—¬", img:VIRUS_IMAGES.low[0]},
      {id:"vL2",name:"ë³µì œ ì„¸í¬",tier:"low",atk:7,hp:20,applyMark:false,bonusVsMarked:0, effect:"", img:VIRUS_IMAGES.low[1]},
      {id:"vL3",name:"ì ì•¡ ë¶„ì—´ì²´",tier:"low",atk:8,hp:16,applyMark:false,bonusVsMarked:2, effect:"í‘œì‹ ìˆëŠ” ëª¬ìŠ¤í„° ê³µê²© ì‹œ ì¶”ê°€ í”¼í•´ +2", img:VIRUS_IMAGES.low[2]},
    ],
    mid:[
      {id:"vM1",name:"ê°ì—¼ í™•ì‚°ì²´",tier:"mid",atk:9,hp:32,applyMark:true, bonusVsMarked:0, effect:"ëª¬ìŠ¤í„° ê³µê²© ì‹œ ëŒ€ìƒì—ê²Œ í‘œì‹(2í„´) ë¶€ì—¬", img:VIRUS_IMAGES.mid[0]},
      {id:"vM2",name:"ë³€ì´ ëŒê²©ì²´",tier:"mid",atk:12,hp:28,applyMark:false,bonusVsMarked:3, effect:"í‘œì‹ ìˆëŠ” ëª¬ìŠ¤í„° ê³µê²© ì‹œ ì¶”ê°€ í”¼í•´ +3", img:VIRUS_IMAGES.mid[1]},
      {id:"vM3",name:"ì€í ì ë³µì²´",tier:"mid",atk:10,hp:30,applyMark:false,bonusVsMarked:0, effect:"", img:VIRUS_IMAGES.mid[2]},
    ],
    high:[
      {id:"vH1",name:"ìˆ™ì£¼ ì§€ë°°ì²´",tier:"high",atk:15,hp:48,applyMark:false,bonusVsMarked:0, effect:"ê°•ì œ ê³µê²© ëŒ€ìƒ / ë°›ì€ í”¼í•´ì˜ 30% ë°˜ì‚¬", img:VIRUS_IMAGES.high[0]},
      {id:"vH2",name:"ì‹ ê²½ ì˜¤ì—¼ì²´",tier:"high",atk:17,hp:40,applyMark:false,bonusVsMarked:5, effect:"í‘œì‹ ìˆëŠ” ëª¬ìŠ¤í„° ê³µê²© ì‹œ ì¶”ê°€ í”¼í•´ +5", img:VIRUS_IMAGES.high[1]},
      {id:"vH3",name:"ì¬ì•™ êµ°ì²´í•µ",tier:"high",atk:15,hp:52,applyMark:false,bonusVsMarked:0, effect:"", img:VIRUS_IMAGES.high[2]},
    ],
  },
  vaccine:{
    low:[
      {id:"cL1",name:"ì£¼ì‚¬ë³‘",tier:"low",atk:6,hp:18, healOn:"none", healAmount:0, effect:"", img:VAX_IMAGES.low[0]},
      {id:"cL2",name:"ì†Œë… ìš”ì›",tier:"low",atk:5,hp:20, healOn:"none", healAmount:0, effect:"", img:VAX_IMAGES.low[1]},
      {id:"cL3",name:"ë°©ì—­ ë“œë¡ ",tier:"low",atk:7,hp:16, healOn:"end",  healAmount:2, effect:"í„´ ì¢…ë£Œ ì‹œ ì•„êµ° ëª¬ìŠ¤í„° ì¤‘ HP ê°€ì¥ ë‚®ì€ 1ì²´ +2 íšŒë³µ", img:VAX_IMAGES.low[2]},
    ],
    mid:[
      {id:"cM1",name:"í•­ì²´ ë°©íŒ¨ë³‘",tier:"mid",atk:8,hp:34, healOn:"hurt",  healAmount:2, effect:"ì•„êµ° ëª¬ìŠ¤í„°ê°€ í”¼í•´ë¥¼ ë°›ì„ ë•Œë§ˆë‹¤ ê·¸ ëª¬ìŠ¤í„° HP +2 íšŒë³µ", img:VAX_IMAGES.mid[0]},
      {id:"cM2",name:"ë©´ì—­ ìˆ˜í˜¸ì",tier:"mid",atk:10,hp:28,healOn:"attack",healAmount:3, effect:"ëª¬ìŠ¤í„° ê³µê²© ì‹œ ì•„êµ° ëª¬ìŠ¤í„° 1ì²´ HP +3 íšŒë³µ", img:VAX_IMAGES.mid[1]},
      {id:"cM3",name:"ì •í™” ê³µë³‘",tier:"mid",atk:9,hp:30, healOn:"attack",healAmount:3, effect:"ëª¬ìŠ¤í„° ê³µê²© ì‹œ ì•„êµ° ëª¬ìŠ¤í„° 1ì²´ HP +3 íšŒë³µ", img:VAX_IMAGES.mid[2]},
    ],
    high:[
      {id:"cH1",name:"ë©´ì—­ ì‚¬ë ¹ê´€",tier:"high",atk:14,hp:48,healOn:"startAll",healAmount:3, effect:"í„´ ì‹œì‘ ì‹œ ì•„êµ° ëª¬ìŠ¤í„° ì „ë¶€ HP +3 íšŒë³µ", img:VAX_IMAGES.high[0]},
      {id:"cH2",name:"ë°±ì‹  ë°°ì–‘ì²´",tier:"high",atk:13,hp:52,healOn:"endAll",  healAmount:2, effect:"í„´ ì¢…ë£Œ ì‹œ ì•„êµ° ëª¬ìŠ¤í„° ì „ë¶€ HP +2 íšŒë³µ", img:VAX_IMAGES.high[1]},
      {id:"cH3",name:"í•­ì› ì œì••ê¸°",tier:"high",atk:17,hp:42,healOn:"none",    healAmount:0, effect:"", img:VAX_IMAGES.high[2]},
    ],
  }
};

const tierLabel=(t)=>t==="low"?"í•˜ê¸‰":t==="mid"?"ì¤‘ê¸‰":"ìƒê¸‰";

/* ===== ë£¸ ìƒíƒœ ===== */
let room=null, me=null, unsub=null;
let lastData=null;

/* ===== UI ì„ íƒ ìƒíƒœ ===== */
let mode="buy";          // buy | summon | attack
let selHand=null;        // ì†íŒ¨ index
let selAttacker=null;    // ë‚´ í•„ë“œ ìŠ¬ë¡¯ index

/* ===== helpers ===== */
function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.classList.remove("hide");
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.classList.add("hide"), 1400);
}
function getPid(r){
  const k="vvd_pid_"+r;
  let v=localStorage.getItem(k);
  if(!v){ v=crypto.randomUUID(); localStorage.setItem(k,v); }
  return v;
}
async function loadRoom(){
  if(!room) throw new Error("no room");
  const ref=doc(db,"rooms",room);
  const snap=await getDoc(ref);
  if(!snap.exists()) throw new Error("no room");
  return {ref,data:snap.data()};
}
const pids=(d)=>Object.keys(d.players||{});
const otherPid=(d)=>pids(d).find(pid=>pid!==me)||null;
const myData=(d)=>d.players?.[me]||null;
const opData=(d)=>{const op=otherPid(d); return op?d.players[op]:null;};
const aliveCount=(field)=>(field||[]).filter(x=>x && x.alive!==false).length;

/* í”Œë ˆì´ì–´ í”¼ê°: (ë‚´ í•„ë“œ ëª¬ìŠ¤í„° ìˆ˜Ã—20%) + (ë°±ì‹ ì´ë©´ +10%), ìµœëŒ€ 80% */
function playerDR(d,pid){
  const p=d.players?.[pid]; if(!p) return 0;
  const base=0.2*aliveCount(p.field);
  const bonus=(p.faction==="vaccine")?0.1:0;
  return clamp(base+bonus,0,0.8);
}
const canAct=(d)=>d.status==="playing" && d.turnOwner===me;

/* ===== ë§ˆì´ê·¸ë ˆì´ì…˜: ê¸°ì¡´ ë°©ë„ ì ‘ì† ì¦‰ì‹œ ìµœì‹  ê·œì¹™ ì ìš© ===== */
function migrateRoomData(d){
  let changed=false;

  // maxTurn ê¸°ë¡(ìˆë“  ì—†ë“  ë§ì¶°ë‘ )
  if(d.maxTurn !== MAX_TURN){
    d.maxTurn = MAX_TURN;
    changed=true;
  }

  // ê¸°ë³¸ í‚¤ ë³´ì •
  d.lock = d.lock || {};
  d.players = d.players || {};
  if(typeof d.turn !== "number") { d.turn = 1; changed=true; }
  if(typeof d.status !== "string") { d.status = "lobby"; changed=true; }

  // í”Œë ˆì´ì–´/í•„ë“œ ë³´ì • + í‘œì‹/ì ê¹€ ì •ê·œí™”
  for(const pid of Object.keys(d.players)){
    const p=d.players[pid];
    if(!p) continue;

    if(!Array.isArray(p.field) || p.field.length!==4){
      p.field=[null,null,null,null];
      changed=true;
    }
    if(!Array.isArray(p.hand)) { p.hand=[]; changed=true; }
    if(typeof p.hp !== "number") { p.hp=100; changed=true; }
    if(typeof p.mana !== "number") { p.mana=0; changed=true; }

    for(let i=0;i<4;i++){
      const m=p.field[i];
      if(!m) continue;

      // í‘œì‹ í•„ë“œ(ëª¬ìŠ¤í„°ì—ë§Œ)
      if(typeof m.marked !== "boolean"){ m.marked=false; changed=true; }
      if(typeof m.markTurns !== "number"){ m.markTurns=0; changed=true; }
      if(m.markTurns>2){ m.markTurns=2; changed=true; }
      if(m.markTurns<=0){ m.marked=false; m.markTurns=0; }

      // ì£½ì–´ìˆëŠ” ì¹´ë“œ ì •ë¦¬ + 2í„´ ì ê¹€ ë³´ì¥
      if(typeof m.hp==="number" && m.hp<=0){
        p.field[i]=null;
        const k=`${pid}-${i}`;
        if(!d.lock[k] || d.lock[k] < 2){
          d.lock[k]=2;
        }
        changed=true;
      }

      // instId ì—†ìœ¼ë©´ ë¶€ì—¬(ì¤‘ë³µê³µê²© ì²´í¬ìš©)
      if(!m.instId){
        m.instId = uid();
        changed=true;
      }

      // alive ê¸°ë³¸
      if(typeof m.alive !== "boolean"){
        m.alive = true;
        changed=true;
      }
    }
  }

  // í„´ ì´ˆê³¼ë©´ ê²Œì„ ì¢…ë£Œë¡œ ì •ë¦¬
  if(d.status==="playing" && d.turn > MAX_TURN){
    d.status="end";
    const ps=pids(d);
    if(ps.length===2){
      const hp0=d.players[ps[0]]?.hp ?? 0;
      const hp1=d.players[ps[1]]?.hp ?? 0;
      d.winner = (hp0===hp1) ? "draw" : (hp0>hp1 ? ps[0] : ps[1]);
    }else{
      d.winner="draw";
    }
    changed=true;
  }

  return changed;
}

/* í‘œì‹ í„´ ê°ì†Œ(ì „ì—­): í„´ ì‹œì‘ë§ˆë‹¤ ëª¨ë“  ëª¬ìŠ¤í„°ì˜ í‘œì‹ í„´ -1 */
function tickMarks(d){
  for(const pid of pids(d)){
    const pl=d.players[pid];
    for(let i=0;i<4;i++){
      const m=pl.field?.[i];
      if(m && m.marked){
        m.markTurns = (m.markTurns||0) - 1;
        if(m.markTurns<=0){
          m.marked=false;
          m.markTurns=0;
        }
      }
    }
  }
}

/* í„´ ì‹œì‘ ì²˜ë¦¬ */
function ensureTurnStart(d){
  d.turnState=d.turnState||{};
  const k=`${d.turn}-${d.turnOwner}`;
  if(d.turnState.startedKey===k) return;

  // í‘œì‹ ê°ì†Œ
  tickMarks(d);

  const p=d.players?.[d.turnOwner];
  if(p){
    p.mana=(p.mana||0)+3;
    d.actionLeft=2;
    d.attackedThisTurn=[];
    d.turnBuy=d.turnBuy||{};

    // ìŠ¬ë¡¯ ì ê¹€ ê°ì†Œ(í•´ë‹¹ í”Œë ˆì´ì–´ì˜ í„´ ì‹œì‘ë§ˆë‹¤ ê°ì†Œ)
    d.lock=d.lock||{};
    for(let s=0;s<4;s++){
      const lk=`${d.turnOwner}-${s}`;
      if(d.lock[lk] && d.lock[lk]>0) d.lock[lk]-=1;
      if(d.lock[lk]===0) delete d.lock[lk];
    }

    // ë°±ì‹ : í„´ ì‹œì‘ ì „ì—­ íšŒë³µ(ë©´ì—­ ì‚¬ë ¹ê´€)
    if(p.faction==="vaccine"){
      const hasStartAll = (p.field||[]).some(m=>m && m.healOn==="startAll");
      if(hasStartAll){
        for(let i=0;i<4;i++){
          const m=p.field[i];
          if(m) m.hp += 3;
        }
      }
    }
  }

  d.turnState.startedKey=k;
}

/* ìˆ™ì£¼ ì§€ë°°ì²´ ê°•ì œ ê³µê²© ëŒ€ìƒ */
function findForcedTargetIndex(opPlayer){
  for(let i=0;i<4;i++){
    const m=opPlayer?.field?.[i];
    if(m && m.id==="vH1") return i;
  }
  return null;
}

/* ê²°ê³¼ ì˜¤ë²„ë ˆì´ */
function showResult(d){
  const box=$("result");
  const title=$("resultTitle");
  const sub=$("resultSub");

  const w=d.winner;
  const msg = (w==="draw") ? "ë¬´ìŠ¹ë¶€" : (w===me) ? "ìŠ¹ë¦¬!" : "íŒ¨ë°°";
  title.textContent = msg;

  const my=myData(d);
  const op=opData(d);
  const myHp=my?.hp ?? 0;
  const opHp=op?.hp ?? 0;
  const t=Math.min(d.turn,MAX_TURN);
  sub.textContent = `ë‚´ HP: ${myHp} Â· ìƒëŒ€ HP: ${opHp} Â· í„´: ${t}/${MAX_TURN}`;

  box.classList.remove("hide");
}
$("restartBtn").onclick=()=>location.reload();

/* ===== UI ===== */
function cardNode(m, extra=""){
  const div=document.createElement("div");
  div.className="card";
  const atkTxt = (typeof m.atk === "number") ? m.atk : "-";
  div.innerHTML=`
    <img class="thumb" src="${(m.img&&m.img.trim())?m.img:fallbackImg}" alt="">
    <div class="meta">
      <div class="name">${m.name}</div>
      <div class="stats">
        <span class="chip2">âš” ${atkTxt}</span>
        <span class="chip2">â¤ ${m.hp}</span>
        ${m.marked? `<span class="chip2 mark">â˜£ í‘œì‹</span>` : ``}
        <span class="chip2">${tierLabel(m.tier || "mid")}</span>
        ${extra}
      </div>
      <div class="fx">${m.effect || "íš¨ê³¼ ì—†ìŒ"}</div>
    </div>
  `;
  return div;
}
function setMode(m){
  mode=m;
  selHand=null; selAttacker=null;
  $("helpPill").textContent =
    m==="buy" ? "êµ¬ë§¤: ë²„íŠ¼ í´ë¦­(í„´ë‹¹ 1íšŒ)" :
    m==="summon" ? "ì†Œí™˜: ì†íŒ¨ í´ë¦­ â†’ ë‚´ ë¹ˆ ìŠ¬ë¡¯ í´ë¦­(í–‰ë™ 1)" :
    "ê³µê²©: ë‚´ ëª¬ìŠ¤í„° í´ë¦­ â†’ ìƒëŒ€(ëª¬ìŠ¤í„°/PLAYER) í´ë¦­(í„´ë‹¹ 2íšŒ, ì¤‘ë³µê³µê²© ë¶ˆê°€)";
  toast(m==="buy"?"êµ¬ë§¤ ëª¨ë“œ":m==="summon"?"ì†Œí™˜ ëª¨ë“œ":"ê³µê²© ëª¨ë“œ");
  renderUI(lastData);
}
function renderLobby(d){
  const ps=pids(d);
  const picked=ps.filter(pid=>!!d.players?.[pid]?.faction).length;
  const isHost=(d.host===me);

  $("lobbyStatus").textContent = `ì°¸ê°€ ${ps.length}/2 Â· ì§„ì˜ ì„ íƒ ${picked}/2` + (isHost?" Â· í˜¸ìŠ¤íŠ¸":"");
  $("start").classList.toggle("hide", !isHost);
  $("lobbyInfo").textContent = room ? `ROOM:${room}  me:${me?.slice(0,8)}` : "";
}

/* ìƒëŒ€ í•„ë“œ: + PLAYER ìŠ¬ë¡¯(5ë²ˆì§¸) */
function renderField(containerId, d, pid, isMine){
  const cont=$(containerId);
  cont.innerHTML="";
  const p=d.players?.[pid];
  const lock=d.lock||{};
  const slots = isMine ? 4 : 5;

  for(let i=0;i<slots;i++){
    // ìƒëŒ€ PLAYER ìŠ¬ë¡¯
    if(!isMine && i===4){
      const slot=document.createElement("div");
      slot.className="slot";

      const hdr=document.createElement("div");
      hdr.className="slotHdr";
      hdr.innerHTML=`<span class="badge">ìƒëŒ€ PLAYER</span>`;
      slot.appendChild(hdr);

      const hp = d.players?.[pid]?.hp ?? 0;
      const fakePlayer = {name:"ìƒëŒ€ í”Œë ˆì´ì–´", atk:"-", hp, tier:"high", marked:false, effect:"í´ë¦­í•˜ë©´ í”Œë ˆì´ì–´ë¥¼ ê³µê²©", img:""};
      slot.appendChild(cardNode(fakePlayer));

      slot.addEventListener("click", ()=>onSlotClick(false, 4));
      cont.appendChild(slot);
      continue;
    }

    const lk=`${pid}-${i}`;
    const lockedTurns=lock[lk]||0;
    const m=p?.field?.[i]||null;

    const slot=document.createElement("div");
    slot.className="slot";

    const hdr=document.createElement("div");
    hdr.className="slotHdr";
    hdr.innerHTML=`
      <span class="badge">${isMine?"ë‚´":"ìƒëŒ€"} ${i}</span>
      ${lockedTurns? `<span class="badge lock">ì ê¹€ ${lockedTurns}</span>` : ``}
    `;
    slot.appendChild(hdr);

    if(m){
      const node=cardNode(m);
      if(isMine && mode==="attack" && selAttacker===i) node.classList.add("selected");
      slot.appendChild(node);
    }else{
      const e=document.createElement("div");
      e.className="emptyHint";
      e.textContent="EMPTY";
      slot.appendChild(e);
    }
    if(lockedTurns){
      const ov=document.createElement("div");
      ov.className="overlay";
      ov.textContent="LOCKED";
      slot.appendChild(ov);
    }

    slot.addEventListener("click", ()=>onSlotClick(isMine, i));
    cont.appendChild(slot);
  }
}

function renderHand(d){
  const cont=$("hand");
  cont.innerHTML="";
  const my=myData(d);
  const hand=my?.hand||[];
  $("handCount").textContent=`${hand.length}`; // âœ… ì†íŒ¨ ì œí•œ ì—†ìŒ

  hand.forEach((c, idx)=>{
    const wrap=document.createElement("div");
    wrap.className="hcard";
    const node=cardNode(c, `<span class="chip2">#${idx}</span>`);
    if(mode==="summon" && selHand===idx) node.classList.add("selected");
    wrap.appendChild(node);

    wrap.addEventListener("click", ()=>{
      if(!canAct(d)) return toast("ìƒëŒ€ í„´");
      if(mode!=="summon") return toast("ì†Œí™˜ ëª¨ë“œë¡œ ë³€ê²½");
      selHand=idx;
      toast("ì†íŒ¨ ì„ íƒ");
      renderUI(lastData);
    });

    cont.appendChild(wrap);
  });
}

function renderUI(d){
  if(!d) return;
  lastData=d;

  $("lobby").classList.toggle("hide", d.status!=="lobby");
  $("game").classList.toggle("hide", d.status==="lobby");

  if(d.status==="lobby"){ renderLobby(d); return; }

  const my=myData(d), op=opData(d), opPid=otherPid(d);

  $("roomPill").textContent="ROOM: "+(room||"-");
  $("turnPill").textContent=`TURN ${Math.min(d.turn,MAX_TURN)}/${MAX_TURN} Â· ${(d.turnOwner===me)?"ë‚´ í„´":"ìƒëŒ€ í„´"}`;
  $("youPill").textContent = my?.faction==="virus" ? "YOU: ğŸ¦ " : "YOU: ğŸ’‰";

  const hp=my?.hp ?? 0;
  $("hpText").textContent=String(hp);
  const w=clamp(hp,0,100);
  $("hpFill").style.width=w+"%";
  $("hpFill").classList.toggle("bad", w<35);

  $("manaPill").textContent="MANA "+(my?.mana ?? 0);
  $("actPill").textContent="ACT "+(d.actionLeft ?? 0)+"/2";
  $("atkPill").textContent="ATK "+((d.attackedThisTurn?.length)||0)+"/2";

  const dr=playerDR(d, me);
  $("myInfo").textContent = `í”¼ê°:${Math.round(dr*100)}%`;
  $("opInfo").textContent = `ìƒëŒ€HP:${op?.hp ?? 0}`;

  const enabled=canAct(d);
  $("buy").disabled=!enabled;
  $("endTurn").disabled=!enabled;
  $("modeBuy").disabled=!enabled;
  $("modeSummon").disabled=!enabled;
  $("modeAttack").disabled=!enabled;

  if(opPid) renderField("opField", d, opPid, false);
  renderField("myField", d, me, true);
  renderHand(d);
}

/* ===== íšŒë³µ í—¬í¼(ë°±ì‹ ) ===== */
function healLowestOne(player, amount){
  let idx=-1, min=Infinity;
  for(let i=0;i<4;i++){
    const m=player.field[i];
    if(m && m.hp < min){ min=m.hp; idx=i; }
  }
  if(idx>=0) player.field[idx].hp += amount;
}
function healAll(player, amount){
  for(let i=0;i<4;i++){
    const m=player.field[i];
    if(m) m.hp += amount;
  }
}
function healRandomOne(player, amount){
  const list=[];
  for(let i=0;i<4;i++) if(player.field[i]) list.push(i);
  if(!list.length) return;
  const pick=list[Math.floor(Math.random()*list.length)];
  player.field[pick].hp += amount;
}

/* ===== í´ë¦­ ì¡°ì‘ ë¡œì§ ===== */
async function onSlotClick(isMine, idx){
  const {ref,data}=await loadRoom();
  if(data.status!=="playing") return;
  if(!canAct(data)) return toast("ìƒëŒ€ í„´");

  const my=myData(data);
  const opPid=otherPid(data);
  const op=opPid?data.players[opPid]:null;
  if(!my) return;

  if(mode==="buy") return;

  // ì†Œí™˜
  if(mode==="summon"){
    if(!isMine) return toast("ë‚´ ìŠ¬ë¡¯ì—ë§Œ ì†Œí™˜");
    if(selHand==null) return toast("ì†íŒ¨ ë¨¼ì € ì„ íƒ");
    if((data.actionLeft??0)<=0) return toast("í–‰ë™ 0");
    if(my.field[idx]) return toast("ì´ë¯¸ ëª¬ìŠ¤í„° ìˆìŒ");
    if((data.lock||{})[`${me}-${idx}`]) return toast("ì ê¹€");

    const card=my.hand[selHand];
    if(!card) return toast("ì†íŒ¨ ì˜¤ë¥˜");

    my.field[idx]={...card, alive:true};
    my.hand.splice(selHand,1);
    data.players[me]=my;
    data.actionLeft-=1;

    await setDoc(ref,data);
    selHand=null;
    toast("ì†Œí™˜!");
    return;
  }

  // ê³µê²©
  if(mode==="attack"){
    data.attackedThisTurn=data.attackedThisTurn||[];
    if(data.attackedThisTurn.length>=2) return toast("ê³µê²© 2íšŒ ë");

    if(isMine){
      const a=my.field[idx];
      if(!a) return toast("ê³µê²©ì ì—†ìŒ");
      if(data.attackedThisTurn.includes(a.instId)) return toast("ì´ë¯¸ ê³µê²©í•¨");
      selAttacker=idx;
      toast("ê³µê²©ì ì„ íƒ");
      renderUI(data);
      return;
    }

    if(selAttacker==null) return toast("ë‚´ ëª¬ìŠ¤í„° ë¨¼ì € ì„ íƒ");
    if(!op) return toast("ìƒëŒ€ ì—†ìŒ");

    const attacker=my.field[selAttacker];
    if(!attacker) return toast("ê³µê²©ì ì‚¬ë¼ì§");
    if(data.attackedThisTurn.includes(attacker.instId)) return toast("ì¤‘ë³µ ê³µê²©");

    // âœ… ìƒëŒ€ PLAYER ìŠ¬ë¡¯
    if(idx===4){
      const dr=playerDR(data, opPid);
      const dmg=Math.max(1, Math.floor(attacker.atk*(1-dr)));
      op.hp -= dmg;

      data.players[opPid]=op;
      data.attackedThisTurn.push(attacker.instId);

      if(op.hp<=0){
        data.status="end";
        data.winner=me;
      }

      await setDoc(ref,data);
      selAttacker=null;
      toast(`í”Œë ˆì´ì–´ í”¼í•´ ${dmg}`);
      return;
    }

    // ê°•ì œ ê³µê²© ëŒ€ìƒ
    const mustIdx=findForcedTargetIndex(op);
    if(mustIdx!=null && mustIdx!==idx){
      return toast("ìˆ™ì£¼ ì§€ë°°ì²´ë¥¼ ë¨¼ì € ê³µê²©!");
    }

    const target=op.field[idx];
    if(!target) return toast("ëŒ€ìƒ ì—†ìŒ");

    // âœ… ë°ë¯¸ì§€ ê³„ì‚°(í‘œì‹ ì¶”ë€)
    let dmg = attacker.atk;
    if(attacker.bonusVsMarked && target.marked) dmg += attacker.bonusVsMarked;

    // í”¼í•´ ì ìš©
    target.hp -= dmg;

    // âœ… ë°±ì‹ (ê³µê²© ì‹œ) íšŒë³µ: ëœë¤ ì•„êµ° 1ì²´
    if(my.faction==="vaccine" && attacker.healOn==="attack" && (attacker.healAmount||0)>0){
      healRandomOne(my, attacker.healAmount||0);
    }

    // âœ… ë°”ì´ëŸ¬ìŠ¤(ëª¬ìŠ¤í„° ê³µê²© ì‹œ) í‘œì‹ ë¶€ì—¬
    if(my.faction==="virus" && attacker.applyMark){
      target.marked=true;
      target.markTurns=2;
    }

    // âœ… ë°±ì‹ (í”¼í•´ ë°›ì„ ë•Œ) íšŒë³µ: ë°©íŒ¨ë³‘(hurt)
    // ìƒëŒ€(op)ê°€ ë°±ì‹ ì´ë©´, ì´ë²ˆì— í”¼í•´ ë°›ì€ target(=opì˜ ëª¬ìŠ¤í„°)ì„ íšŒë³µ
    if(op.faction==="vaccine"){
      const shields = (op.field||[]).filter(m=>m && m.healOn==="hurt" && (m.healAmount||0)>0).length;
      if(shields>0 && target.hp>0){
        target.hp += shields * 2; // ë°©íŒ¨ë³‘ 1ì¥ë‹¹ +2
      }
    }

    // ë°˜ì‚¬(ìˆ™ì£¼ ì§€ë°°ì²´)
    if(target.id==="vH1"){
      const reflect=Math.floor(dmg*0.3);
      attacker.hp -= reflect;

      if(attacker.hp<=0){
        my.field[selAttacker]=null;
        data.lock=data.lock||{};
        data.lock[`${me}-${selAttacker}`]=2; // âœ… 2í„´ ì ê¹€
        toast("ë°˜ì‚¬ë¡œ ê³µê²©ì ì‚¬ë§!");
      }else{
        my.field[selAttacker]=attacker;
      }
    }else{
      my.field[selAttacker]=attacker;
    }

    // ëŒ€ìƒ ì‚¬ë§ ì²˜ë¦¬
    if(target.hp<=0){
      op.field[idx]=null;
      data.lock=data.lock||{};
      data.lock[`${opPid}-${idx}`]=2; // âœ… 2í„´ ì ê¹€
      toast("ì²˜ì¹˜!");
    }else{
      op.field[idx]=target;
      toast(`íƒ€ê²©! (-${dmg})`);
    }

    data.players[me]=my;
    data.players[opPid]=op;
    data.attackedThisTurn.push(attacker.instId);

    if(op.hp<=0){
      data.status="end";
      data.winner=me;
    }

    await setDoc(ref,data);
    selAttacker=null;
    return;
  }
}

/* ===== ì¹´ë“œ ìƒì„±/êµ¬ë§¤ ===== */
function makeCard(faction, tier){
  const pool = MONSTERS[faction][tier];
  const base = pool[Math.floor(Math.random()*pool.length)];
  const card = structuredClone(base);
  card.cost = COST[tier];
  card.instId = uid();
  card.alive = true;
  card.marked = false;
  card.markTurns = 0;
  return card;
}

async function buyCard(){
  const {ref,data}=await loadRoom();
  if(!canAct(data)) return toast("ìƒëŒ€ í„´");
  const my=myData(data); if(!my) return;

  // í„´ë‹¹ 1íšŒ êµ¬ë§¤
  data.turnBuy=data.turnBuy||{};
  const key=`${data.turn}-${me}`;
  if(data.turnBuy[key]) return toast("ì´ë²ˆ í„´ êµ¬ë§¤ ì™„ë£Œ");

  const tier=$("tierSel").value;
  const cost=COST[tier];
  if((my.mana||0)<cost) return toast("ë§ˆë‚˜ ë¶€ì¡±");

  const card = makeCard(my.faction, tier);

  my.mana-=cost;
  my.hand.push(card); // âœ… ì†íŒ¨ ì œí•œ ì‚­ì œ

  data.players[me]=my;
  data.turnBuy[key]=true;

  await setDoc(ref,data);
  toast("êµ¬ë§¤!");
}

/* ===== í„´ ì¢…ë£Œ(20í„´ ëë‚˜ë©´ ì¢…ë£Œ) ===== */
async function endTurn(){
  const {ref,data}=await loadRoom();
  if(!canAct(data)) return toast("ìƒëŒ€ í„´");

  const opPid=otherPid(data);
  if(!opPid) return toast("ìƒëŒ€ ì—†ìŒ");

  // âœ… í„´ ì¢…ë£Œ ì‹œ ë°±ì‹  íšŒë³µ(ë‚´ í„´ ëì—ì„œ ì ìš©)
  const my=myData(data);
  if(my?.faction==="vaccine"){
    // endAll(ë°±ì‹  ë°°ì–‘ì²´)
    const hasEndAll = (my.field||[]).some(m=>m && m.healOn==="endAll");
    if(hasEndAll) healAll(my, 2);

    // end(ë°©ì—­ ë“œë¡ ) - ì—¬ëŸ¬ ì¥ì´ë©´ ì—¬ëŸ¬ ë²ˆ
    const drones = (my.field||[]).filter(m=>m && m.healOn==="end" && (m.healAmount||0)>0);
    for(const d0 of drones) healLowestOne(my, d0.healAmount||2);

    data.players[me]=my;
  }

  // ë‹¤ìŒ í„´ìœ¼ë¡œ ë„˜ê¸°ê¸°
  data.turn += 1;
  data.turnOwner = opPid;

  // âœ… 21í„´ ì§„ì…ì´ë©´ ê²Œì„ ì¢…ë£Œ(= 20í„´ê¹Œì§€ ì§„í–‰)
  if(data.turn > MAX_TURN){
    data.status="end";
    const ps=pids(data);
    const hp0=data.players[ps[0]]?.hp ?? 0;
    const hp1=data.players[ps[1]]?.hp ?? 0;
    data.winner = (hp0===hp1) ? "draw" : (hp0>hp1 ? ps[0] : ps[1]);
    await setDoc(ref,data);
    toast("ê²Œì„ ì¢…ë£Œ");
    return;
  }

  ensureTurnStart(data);
  await setDoc(ref,data);
  toast("í„´ ì¢…ë£Œ");
}

/* ===== ë¡œë¹„ ===== */
$("create").onclick=async ()=>{
  room=rid();
  me=getPid(room);

  await setDoc(doc(db,"rooms",room),{
    host: me,
    status:"lobby",
    maxTurn: MAX_TURN,
    turn:1,
    turnOwner:null,
    actionLeft:2,
    attackedThisTurn:[],
    players:{},
    lock:{},
    turnState:{},
    turnBuy:{},
    createdAt:serverTimestamp()
  });

  $("code").value=room;
  $("lobbyInfo").textContent=`ROOM:${room}  me:${me.slice(0,8)}`;
  listen();
};

$("join").onclick=()=>{
  const v=$("code").value.trim().toUpperCase();
  if(!v) return;
  room=v;
  me=getPid(room);
  $("lobbyInfo").textContent=`ROOM:${room}  me:${me.slice(0,8)}`;
  listen();
};

async function chooseFaction(faction){
  const {ref,data}=await loadRoom();
  data.players=data.players||{};
  data.players[me]={
    faction,
    hp:100,
    mana:0,
    field:[null,null,null,null],
    hand:[]
  };
  await setDoc(ref,data);
  toast(faction==="virus"?"ğŸ¦  ì„ íƒ":"ğŸ’‰ ì„ íƒ");
}
$("virus").onclick=()=>chooseFaction("virus");
$("vaccine").onclick=()=>chooseFaction("vaccine");

$("start").onclick=async ()=>{
  const {ref,data}=await loadRoom();
  if(data.host!==me) return toast("í˜¸ìŠ¤íŠ¸ë§Œ ê°€ëŠ¥");

  const ps=pids(data);
  if(ps.length!==2) return toast("í”Œë ˆì´ì–´ 2ëª… í•„ìš”");
  const picked=ps.filter(pid=>!!data.players?.[pid]?.faction).length;
  if(picked!==2) return toast("ë‘˜ ë‹¤ ì§„ì˜ ì„ íƒ í•„ìš”");

  data.status="playing";
  data.turnOwner = ps[Math.floor(Math.random()*2)];
  ensureTurnStart(data);

  await setDoc(ref,data);

  setMode("buy");
  toast("ê²Œì„ ì‹œì‘!");
};

/* ===== ëª¨ë“œ/ë²„íŠ¼ ===== */
$("modeBuy").onclick=()=>setMode("buy");
$("modeSummon").onclick=()=>setMode("summon");
$("modeAttack").onclick=()=>setMode("attack");
$("buy").onclick=buyCard;
$("endTurn").onclick=endTurn;

/* ===== realtime ===== */
function listen(){
  if(!room) return;
  if(unsub) unsub();

  unsub=onSnapshot(doc(db,"rooms",room), async (snap)=>{
    if(!snap.exists()){
      toast("ë°© ì—†ìŒ");
      return;
    }
    const {ref,data}=await loadRoom();

    // âœ… ê¸°ì¡´ ë°©ë„ ìµœì‹  ê·œì¹™ìœ¼ë¡œ ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜
    if(migrateRoomData(data)){
      await setDoc(ref,data);
    }

    // playingì´ë©´ í„´ ì‹œì‘ ë³´ì •
    if(data.status==="playing"){
      ensureTurnStart(data);
      await setDoc(ref,data);
    }

    // end ì²˜ë¦¬
    if(data.status==="end"){
      showResult(data);
    }

    renderUI(data);
  },(e)=>{
    console.error(e);
    toast("ì—°ê²° ì—ëŸ¬");
  });
}
</script>
</body>
</html>
