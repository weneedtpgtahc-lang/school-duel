<!doctype html>
<div id="virusCards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;"></div>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Virus vs Vaccine Duel</title>
<style>
  :root{
    --bg:#0e1117; --panel:#151a22; --line:#2a3242; --text:#e8eefc; --muted:#a9b4cf;
    --good:#26d07c; --bad:#ff5c5c; --chip:#20283a; --white:#fff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
  .hide{display:none!important}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .sp{justify-content:space-between}
  .pill{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:12px;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

  /* ===== LOBBY (ê¹”ë”/ê°€ë…ì„± ìµœìš°ì„ ) ===== */
  .lobbyWrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
  .lobbyCard{
    width:min(420px, 92vw);
    background:var(--white);
    color:#111;
    border-radius:18px;
    padding:22px;
    box-shadow:0 18px 60px rgba(0,0,0,.45);
    border:1px solid rgba(0,0,0,.08);
    display:flex;flex-direction:column;gap:14px;
  }
  .title{font-size:22px;font-weight:900;text-align:center}
  .subtitle{font-size:13px;color:#444;text-align:center;line-height:1.4}
  .divider{height:1px;background:#e5e7eb;margin:2px 0}
  .lbtn{
    width:100%; border:none; border-radius:12px; padding:13px 12px;
    font-weight:900; font-size:16px; cursor:pointer;
  }
  .lbtn.create{background:#2563eb;color:#fff}
  .lbtn.join{background:#10b981;color:#fff}
  .lbtn.start{background:#111;color:#fff}
  .lbtn.faction{background:#f3f4f6;color:#111}
  .lbtn:active{transform:translateY(1px)}
  .lin{
    width:100%; border:1px solid #d1d5db; border-radius:12px; padding:12px;
    text-align:center; font-size:15px; outline:none;
  }
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .status{font-size:12px;color:#374151;text-align:center}

  /* ===== GAME ===== */
  .app{max-width:1180px;margin:0 auto;padding:14px}
  .topbar{
    position:sticky;top:0;z-index:10;
    background:rgba(14,17,23,.92);backdrop-filter:blur(8px);
    border:1px solid var(--line);border-radius:16px;padding:10px 12px;margin-bottom:10px;
  }
  .btn{
    border:1px solid var(--line); background:linear-gradient(180deg,#1b2230,#141a24);
    color:var(--text); padding:10px 12px;border-radius:12px; font-weight:900; cursor:pointer;
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{border-color:#3a4a70;background:linear-gradient(180deg,#243151,#172137)}
  .btn.good{border-color:#1f6d4a;background:linear-gradient(180deg,#1f6d4a,#134634)}
  .btn:disabled{opacity:.45;cursor:not-allowed}

  .hpbar{width:160px;height:10px;border-radius:999px;background:#222;border:1px solid var(--line);overflow:hidden}
  .hpfill{height:100%;background:linear-gradient(90deg,#26d07c,#6ef3b1)}
  .hpfill.bad{background:linear-gradient(90deg,#ff5c5c,#ff9a9a)}
  select{
    background:#0f1420;border:1px solid var(--line);color:var(--text);
    padding:10px 12px;border-radius:12px;outline:none;
  }

  .panel{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:12px;margin:10px 0}
  .laneTitle{display:flex;align-items:center;justify-content:space-between;margin:0 0 6px}
  .laneTitle span{color:var(--muted);font-size:12px}

  .field{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:10px}
  @media (max-width: 860px){ .field{grid-template-columns:repeat(2,minmax(160px,1fr))} }

  .slot{
    position:relative;border:1px dashed #3a4660;border-radius:16px;background:linear-gradient(180deg,#101522,#0d111b);
    min-height:250px;overflow:hidden;
  }
  .slotHdr{
    position:absolute;left:8px;right:8px;top:8px;
    display:flex;justify-content:space-between;gap:6px;align-items:center;
    pointer-events:none;
  }
  .badge{padding:4px 8px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.08);font-size:12px;color:#cfe1ff}
  .badge.lock{color:#ffd0d0}
  .overlay{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.55);font-weight:900;font-size:16px;color:#fff;
  }

  .card{
    height:100%;display:flex;flex-direction:column;
    border:1px solid #263049;border-radius:16px;overflow:hidden;background:#0c111c;
    cursor:pointer;
  }
  .card.selected{outline:3px solid #fff}
  .thumb{width:100%;height:160px;object-fit:cover;background:#1a2333}
  .meta{padding:10px;display:flex;flex-direction:column;gap:8px}
  .name{font-weight:900;font-size:14px}
  .stats{display:flex;gap:8px;flex-wrap:wrap}
  .chip2{padding:4px 8px;border-radius:999px;background:#141d2e;border:1px solid #263049;font-size:12px;color:#cfe1ff}
  .chip2.mark{color:#d6ff8a}
  .fx{font-size:12px;color:var(--muted);line-height:1.35;min-height:30px}
  .emptyHint{height:100%;display:flex;align-items:center;justify-content:center;color:#5f6b84;font-weight:900}

  .hand{display:flex;gap:10px;overflow:auto;padding-bottom:6px;scroll-snap-type:x mandatory}
  .hcard{min-width:180px;scroll-snap-align:start}

  .toast{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:16px;max-width:min(680px, 92vw);
    background:rgba(0,0,0,.72);backdrop-filter:blur(6px);
    border:1px solid rgba(255,255,255,.14);color:#fff;
    padding:10px 12px;border-radius:999px;font-size:13px;
  }
</style>
</head>

<body>

<!-- ===== LOBBY ===== -->
<div id="lobby" class="lobbyWrap">
  <div class="lobbyCard">
    <div class="title">Virus vs Vaccine Duel</div>
    <div class="subtitle">ë°©ì„ ë§Œë“¤ê±°ë‚˜ ì½”ë“œë¥¼ ì…ë ¥í•´ ì°¸ê°€ â†’ ì§„ì˜ ì„ íƒ â†’ í˜¸ìŠ¤íŠ¸ê°€ ì‹œì‘</div>
    <div class="divider"></div>

    <button id="create" class="lbtn create">ë°© ë§Œë“¤ê¸°</button>
    <input id="code" class="lin" placeholder="ë°© ì½”ë“œ ì…ë ¥" />
    <button id="join" class="lbtn join">ë°© ì°¸ê°€</button>

    <div class="divider"></div>

    <div class="grid2">
      <button id="virus" class="lbtn faction">ğŸ¦  ë°”ì´ëŸ¬ìŠ¤</button>
      <button id="vaccine" class="lbtn faction">ğŸ’‰ ë°±ì‹ </button>
    </div>

    <button id="start" class="lbtn start hide">ê²Œì„ ì‹œì‘ (í˜¸ìŠ¤íŠ¸)</button>

    <div class="status" id="lobbyStatus">ì°¸ê°€ 0/2 Â· ì§„ì˜ ì„ íƒ 0/2</div>
    <div class="status mono" id="lobbyInfo"></div>
  </div>
</div>

<!-- ===== GAME ===== -->
<div id="game" class="app hide">
  <div class="topbar">
    <div class="row sp">
      <div class="row">
        <span id="turnPill" class="pill">TURN -/-</span>
        <span id="youPill" class="pill">YOU</span>
        <span id="roomPill" class="pill mono">ROOM: -</span>
      </div>
      <div class="row">
        <div class="row" style="gap:8px">
          <span class="pill">HP</span>
          <div class="hpbar"><div id="hpFill" class="hpfill" style="width:100%"></div></div>
          <span id="hpText" class="pill">100</span>
        </div>
        <span id="manaPill" class="pill">MANA 0</span>
        <span id="actPill" class="pill">ACT 0/2</span>
        <span id="atkPill" class="pill">ATK 0/2</span>
        <button id="endTurn" class="btn primary">í„´ ì¢…ë£Œ</button>
      </div>
    </div>

    <div class="row sp" style="margin-top:8px">
      <div class="row">
        <button id="modeBuy" class="btn">ğŸ›’ êµ¬ë§¤ëª¨ë“œ</button>
        <button id="modeSummon" class="btn">ğŸ§¬ ì†Œí™˜ëª¨ë“œ</button>
        <button id="modeAttack" class="btn">âš”ï¸ ê³µê²©ëª¨ë“œ</button>
        <span id="helpPill" class="pill">êµ¬ë§¤â†’ì†Œí™˜â†’ê³µê²© ìˆœì„œ</span>
      </div>
      <div class="row">
        <select id="tierSel">
          <option value="low">í•˜ê¸‰(2)</option>
          <option value="mid">ì¤‘ê¸‰(5)</option>
          <option value="high">ìƒê¸‰(9)</option>
        </select>
        <button id="buy" class="btn good">êµ¬ë§¤</button>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="laneTitle"><strong>ìƒëŒ€ í•„ë“œ</strong>
      <span id="opInfo" class="pill">í‘œì‹:0</span>
    </div>
    <div id="opField" class="field"></div>
  </div>

  <div class="panel">
    <div class="laneTitle"><strong>ë‚´ í•„ë“œ</strong>
      <span id="myInfo" class="pill">í”¼ê°:0%</span>
    </div>
    <div id="myField" class="field"></div>
  </div>

  <div class="panel">
    <div class="laneTitle"><strong>ë‚´ ì†íŒ¨</strong><span id="handCount" class="pill">0/10</span></div>
    <div id="hand" class="hand"></div>
  </div>

  <div class="panel">
    <div class="laneTitle"><strong>ë””ë²„ê·¸</strong><span class="pill">í•„ìš” ì—†ìœ¼ë©´ ì§€ì›Œë„ ë¨</span></div>
    <pre id="state" style="margin:0;background:#0b0f18;border:1px solid #24304a;color:#cfe1ff;border-radius:14px;padding:10px;max-height:220px;overflow:auto"></pre>
  </div>
</div>

<div id="toast" class="toast hide"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* âœ… Firebase ì„¤ì • */
const firebaseConfig = {
  apiKey: "AIzaSyBIZll4u_E6zHKyoJZqjCI6_P9cxhK1Shs",
  authDomain: "yanngok-9323a.firebaseapp.com",
  projectId: "yanngok-9323a",
  storageBucket: "yanngok-9323a.firebasestorage.app",
  messagingSenderId: "433037582784",
  appId: "1:433037582784:web:43d77ca2530126240a2825",
  measurementId: "G-M51E2S8PQF"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const $ = (id)=>document.getElementById(id);
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const rid=()=>Math.random().toString(36).slice(2,8).toUpperCase();
const uid=()=>Math.random().toString(36).slice(2,10);

const COST={low:2,mid:5,high:9};
const MAX_TURN=15;

/* ===== ì´ë¯¸ì§€ ê²½ë¡œ(ë°”ì´ëŸ¬ìŠ¤ 9ì¥) ===== */
const VIRUS_IMAGES = {
  low:  ["assets/virus/v_low_1.webp","assets/virus/v_low_2.jpg","assets/virus/v_low_3.webp"],
  mid:  ["assets/virus/v_mid_1.webp","assets/virus/v_mid_2.webp","assets/virus/v_mid_3.webp"],
  high: ["assets/virus/v_high_1.webp","assets/virus/v_high_2.jpg","assets/virus/v_high_3.webp"],
};
const fallbackImg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='520' height='360'%3E%3Crect width='100%25' height='100%25' fill='%231a2333'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23cfe1ff' font-size='22'%3ENo Image%3C/text%3E%3C/svg%3E";

/* ===== ëª¬ìŠ¤í„° ë°ì´í„°(í™•ì •í‘œ) ===== */
const POOL={
  virus:{
    low:[
      {id:"vL1",name:"ì¹¨íˆ¬ í¬ì",tier:"low",atk:7,hp:16,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:VIRUS_IMAGES.low[0]},
      {id:"vL2",name:"ë³µì œ ì„¸í¬",tier:"low",atk:6,hp:18,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:VIRUS_IMAGES.low[1]},
      {id:"vL3",name:"ì ì•¡ ë¶„ì—´ì²´",tier:"low",atk:8,hp:14,mark:true, effect:"í”Œë ˆì´ì–´ ê³µê²© ì‹œ í‘œì‹(2í„´) ë¶€ì—¬",img:VIRUS_IMAGES.low[2]},
    ],
    mid:[
      {id:"vM1",name:"ê°ì—¼ í™•ì‚°ì²´",tier:"mid",atk:6,hp:32,mark:false,effect:"íš¨ê³¼ ì—†ìŒ (íƒ±ì»¤)",img:VIRUS_IMAGES.mid[0]},
      {id:"vM2",name:"ë³€ì´ ëŒê²©ì²´",tier:"mid",atk:11,hp:22,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:VIRUS_IMAGES.mid[1]},
      {id:"vM3",name:"ì€í ì ë³µì²´",tier:"mid",atk:8,hp:28,mark:true, effect:"í”Œë ˆì´ì–´ ê³µê²© ì‹œ í‘œì‹(2í„´) ë¶€ì—¬",img:VIRUS_IMAGES.mid[2]},
    ],
    high:[
      {id:"vH1",name:"ìˆ™ì£¼ ì§€ë°°ì²´",tier:"high",atk:9,hp:48,mark:false,effect:"ê°•ì œ ê³µê²© ëŒ€ìƒ / ë°›ì€ í”¼í•´ì˜ 30% ë°˜ì‚¬",img:VIRUS_IMAGES.high[1]},
      {id:"vH2",name:"ì‹ ê²½ ì˜¤ì—¼ì²´",tier:"high",atk:14,hp:34,mark:true, effect:"í”Œë ˆì´ì–´ ê³µê²© ì‹œ í‘œì‹(2í„´) ë¶€ì—¬",img:VIRUS_IMAGES.high[0]},
      {id:"vH3",name:"ì¬ì•™ êµ°ì²´í•µ",tier:"high",atk:10,hp:52,mark:false,effect:"íš¨ê³¼ ì—†ìŒ (ì´ˆê³ ì²´ë ¥)",img:VIRUS_IMAGES.high[2]},
    ],
  },
  vaccine:{
    low:[
      {id:"cL1",name:"ì£¼ì‚¬ë³‘",tier:"low",atk:6,hp:18,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:""},
      {id:"cL2",name:"ì†Œë… ìš”ì›",tier:"low",atk:7,hp:16,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:""},
      {id:"cL3",name:"ë°©ì—­ ë“œë¡ ",tier:"low",atk:5,hp:20,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:""},
    ],
    mid:[
      {id:"cM1",name:"í•­ì²´ ë°©íŒ¨ë³‘",tier:"mid",atk:7,hp:30,mark:false,effect:"íš¨ê³¼ ì—†ìŒ(íƒ±ì»¤)",img:""},
      {id:"cM2",name:"ë©´ì—­ ìˆ˜í˜¸ì",tier:"mid",atk:10,hp:24,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:""},
      {id:"cM3",name:"ì •í™” ê³µë³‘",tier:"mid",atk:9,hp:26,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:""},
    ],
    high:[
      {id:"cH1",name:"ë©´ì—­ ì‚¬ë ¹ê´€",tier:"high",atk:12,hp:44,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:""},
      {id:"cH2",name:"ë°±ì‹  ë°°ì–‘ì²´",tier:"high",atk:9,hp:52,mark:false,effect:"íš¨ê³¼ ì—†ìŒ(ìµœê³  ì²´ë ¥)",img:""},
      {id:"cH3",name:"í•­ì› ì œì••ê¸°",tier:"high",atk:14,hp:40,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:""},
    ],
  }
};

const tierLabel=(t)=>t==="low"?"í•˜ê¸‰":t==="mid"?"ì¤‘ê¸‰":"ìƒê¸‰";

/* ===== ë£¸ ìƒíƒœ ===== */
let room=null, me=null, unsub=null;
let lastData=null;

/* ===== UI ì„ íƒ ìƒíƒœ(ì´ë¯¸ì§€ í´ë¦­ ì¡°ì‘) ===== */
let mode="buy";          // buy | summon | attack
let selHand=null;        // ì†íŒ¨ index
let selAttacker=null;    // ë‚´ í•„ë“œ ìŠ¬ë¡¯ index

/* ===== helpers ===== */
function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.classList.remove("hide");
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.classList.add("hide"), 1400);
}
function getPid(r){
  const k="vvd_pid_"+r;
  let v=localStorage.getItem(k);
  if(!v){ v=crypto.randomUUID(); localStorage.setItem(k,v); }
  return v;
}
async function loadRoom(){
  if(!room) throw new Error("no room");
  const ref=doc(db,"rooms",room);
  const snap=await getDoc(ref);
  if(!snap.exists()) throw new Error("no room");
  return {ref,data:snap.data()};
}
const pids=(d)=>Object.keys(d.players||{});
const otherPid=(d)=>pids(d).find(pid=>pid!==me)||null;
const myData=(d)=>d.players?.[me]||null;
const opData=(d)=>{const op=otherPid(d); return op?d.players[op]:null;};
const aliveCount=(field)=>(field||[]).filter(x=>x && x.alive!==false).length;

/* í”Œë ˆì´ì–´ í”¼ê°: (ë‚´ í•„ë“œ ëª¬ìŠ¤í„° ìˆ˜Ã—20%) + (ë°±ì‹ ì´ë©´ +20%), ìµœëŒ€ 80% */
function playerDR(d,pid){
  const p=d.players?.[pid]; if(!p) return 0;
  const base=0.2*aliveCount(p.field);
  const bonus=(p.faction==="vaccine")?0.2:0;
  return clamp(base+bonus,0,0.8);
}
/* í‘œì‹(2í„´): í‘œì‹ ìˆìœ¼ë©´ ë°›ëŠ” í”Œë ˆì´ì–´ í”¼í•´ +15% */
const markBonus=(p)=>((p?.debuffs?.markTurns||0)>0 ? 0.15 : 0);

const canAct=(d)=>d.status==="playing" && d.turnOwner===me;

/* ëª¬ìŠ¤í„° ì‚¬ë§ ì‹œ í•´ë‹¹ í•„ë“œ ì¹¸ì€ â€œë‹¤ìŒ ìì‹ ì˜ í„´ê¹Œì§€â€ ì ê¹€
   => ì£½ì€ ìª½ í”Œë ˆì´ì–´ì˜ í•´ë‹¹ ìŠ¬ë¡¯ lock=1 ë¡œ ê±¸ê³ , ê·¸ í”Œë ˆì´ì–´ì˜ í„´ ì‹œì‘ì— ê°ì†Œ */
function ensureTurnStart(d){
  d.turnState=d.turnState||{};
  const k=`${d.turn}-${d.turnOwner}`;
  if(d.turnState.startedKey===k) return;

  const p=d.players?.[d.turnOwner];
  if(p){
    p.mana=(p.mana||0)+3;
    d.actionLeft=2;
    d.attackedThisTurn=[];
    d.turnBuy=d.turnBuy||{};
    p.debuffs=p.debuffs||{};
    if(p.debuffs.markTurns) p.debuffs.markTurns=Math.max(0, p.debuffs.markTurns-1);

    d.lock=d.lock||{};
    for(let s=0;s<4;s++){
      const lk=`${d.turnOwner}-${s}`;
      if(d.lock[lk] && d.lock[lk]>0) d.lock[lk]-=1;
      if(d.lock[lk]===0) delete d.lock[lk];
    }
  }
  d.turnState.startedKey=k;
}

/* ìˆ™ì£¼ ì§€ë°°ì²´ ê°•ì œ ê³µê²© ëŒ€ìƒ */
function findForcedTargetIndex(opPlayer){
  for(let i=0;i<4;i++){
    const m=opPlayer?.field?.[i];
    if(m && m.id==="vH1") return i;
  }
  return null;
}

/* ===== UI render ===== */
function cardNode(m, extra=""){
  const div=document.createElement("div");
  div.className="card";
  div.innerHTML=`
    <img class="thumb" src="${(m.img&&m.img.trim())?m.img:fallbackImg}" alt="">
    <div class="meta">
      <div class="name">${m.name}</div>
      <div class="stats">
        <span class="chip2">âš” ${m.atk}</span>
        <span class="chip2">â¤ ${m.hp}</span>
        ${m.mark? `<span class="chip2 mark">â˜£ í‘œì‹</span>` : ``}
        <span class="chip2">${tierLabel(m.tier)}</span>
        ${extra}
      </div>
      <div class="fx">${m.effect||"íš¨ê³¼ ì—†ìŒ"}</div>
    </div>
  `;
  return div;
}
function setMode(m){
  mode=m;
  selHand=null; selAttacker=null;
  $("helpPill").textContent =
    m==="buy" ? "êµ¬ë§¤: ë²„íŠ¼ í´ë¦­(í„´ë‹¹ 1íšŒ)" :
    m==="summon" ? "ì†Œí™˜: ì†íŒ¨ í´ë¦­ â†’ ë‚´ ë¹ˆ ìŠ¬ë¡¯ í´ë¦­(í–‰ë™ 1)" :
    "ê³µê²©: ë‚´ ëª¬ìŠ¤í„° í´ë¦­ â†’ ìƒëŒ€(ëª¬ìŠ¤í„°/í”Œë ˆì´ì–´) í´ë¦­(í„´ë‹¹ 2íšŒ, ì¤‘ë³µê³µê²© ë¶ˆê°€)";
  toast(m==="buy"?"êµ¬ë§¤ ëª¨ë“œ":m==="summon"?"ì†Œí™˜ ëª¨ë“œ":"ê³µê²© ëª¨ë“œ");
  renderUI(lastData);
}

function renderLobby(d){
  const ps=pids(d);
  const picked=ps.filter(pid=>!!d.players?.[pid]?.faction).length;
  const isHost=(d.host===me);

  $("lobbyStatus").textContent = `ì°¸ê°€ ${ps.length}/2 Â· ì§„ì˜ ì„ íƒ ${picked}/2` + (isHost?" Â· í˜¸ìŠ¤íŠ¸":"");
  $("start").classList.toggle("hide", !isHost);

  $("lobbyInfo").textContent = room ? `ROOM:${room}  me:${me?.slice(0,8)}` : "";
}

function renderField(containerId, d, pid, isMine){
  const cont=$(containerId);
  cont.innerHTML="";
  const p=d.players?.[pid];
  const lock=d.lock||{};

  for(let i=0;i<4;i++){
    const lk=`${pid}-${i}`;
    const lockedTurns=lock[lk]||0;
    const m=p?.field?.[i]||null;

    const slot=document.createElement("div");
    slot.className="slot";

    const hdr=document.createElement("div");
    hdr.className="slotHdr";
    hdr.innerHTML=`
      <span class="badge">${isMine?"ë‚´":"ìƒëŒ€"} ${i}</span>
      ${lockedTurns? `<span class="badge lock">ì ê¹€ ${lockedTurns}</span>` : ``}
    `;
    slot.appendChild(hdr);

    if(m){
      const node=cardNode(m);
      if(isMine && mode==="attack" && selAttacker===i) node.classList.add("selected");
      slot.appendChild(node);
    }else{
      const e=document.createElement("div");
      e.className="emptyHint";
      e.textContent="EMPTY";
      slot.appendChild(e);
    }
    if(lockedTurns){
      const ov=document.createElement("div");
      ov.className="overlay";
      ov.textContent="LOCKED";
      slot.appendChild(ov);
    }

    slot.addEventListener("click", ()=>onSlotClick(isMine, i));
    cont.appendChild(slot);
  }
}

function renderHand(d){
  const cont=$("hand");
  cont.innerHTML="";
  const my=myData(d);
  const hand=my?.hand||[];
  $("handCount").textContent=`${hand.length}/10`;

  hand.forEach((c, idx)=>{
    const wrap=document.createElement("div");
    wrap.className="hcard";
    const node=cardNode(c, `<span class="chip2">#${idx}</span>`);
    if(mode==="summon" && selHand===idx) node.classList.add("selected");
    wrap.appendChild(node);

    wrap.addEventListener("click", ()=>{
      if(!canAct(d)) return toast("ìƒëŒ€ í„´");
      if(mode!=="summon") return toast("ì†Œí™˜ ëª¨ë“œë¡œ ë³€ê²½");
      selHand=idx;
      toast("ì†íŒ¨ ì„ íƒ");
      renderUI(lastData);
    });

    cont.appendChild(wrap);
  });
}

function renderUI(d){
  if(!d) return;
  lastData=d;
  $("state").textContent = JSON.stringify(d,null,2);

  // view switch
  $("lobby").classList.toggle("hide", d.status!=="lobby");
  $("game").classList.toggle("hide", d.status==="lobby");

  if(d.status==="lobby"){ renderLobby(d); return; }

  const my=myData(d), op=opData(d), opPid=otherPid(d);

  $("roomPill").textContent="ROOM: "+(room||"-");
  $("turnPill").textContent=`TURN ${d.turn}/${MAX_TURN} Â· ${(d.turnOwner===me)?"ë‚´ í„´":"ìƒëŒ€ í„´"}`;
  $("youPill").textContent = my?.faction==="virus" ? "YOU: ğŸ¦ " : "YOU: ğŸ’‰";

  const hp=my?.hp ?? 0;
  $("hpText").textContent=String(hp);
  const w=clamp(hp,0,100);
  $("hpFill").style.width=w+"%";
  $("hpFill").classList.toggle("bad", w<35);

  $("manaPill").textContent="MANA "+(my?.mana ?? 0);
  $("actPill").textContent="ACT "+(d.actionLeft ?? 0)+"/2";
  $("atkPill").textContent="ATK "+((d.attackedThisTurn?.length)||0)+"/2";

  const dr=playerDR(d, me);
  $("myInfo").textContent = `í”¼ê°:${Math.round(dr*100)}% Â· ë‚´í‘œì‹:${my?.debuffs?.markTurns||0}`;
  $("opInfo").textContent = `ìƒëŒ€í‘œì‹:${op?.debuffs?.markTurns||0}`;

  const enabled=canAct(d);
  $("buy").disabled=!enabled;
  $("endTurn").disabled=!enabled;
  $("modeBuy").disabled=!enabled;
  $("modeSummon").disabled=!enabled;
  $("modeAttack").disabled=!enabled;

  if(opPid) renderField("opField", d, opPid, false);
  renderField("myField", d, me, true);
  renderHand(d);
}

/* ===== í´ë¦­ ì¡°ì‘ ë¡œì§ ===== */
async function onSlotClick(isMine, idx){
  const {ref,data}=await loadRoom();
  if(data.status!=="playing") return;
  if(!canAct(data)) return toast("ìƒëŒ€ í„´");

  const my=myData(data);
  const opPid=otherPid(data);
  const op=opPid?data.players[opPid]:null;
  if(!my) return;

  // êµ¬ë§¤ ëª¨ë“œ: ìŠ¬ë¡¯ í´ë¦­ì€ ë¬´ì‹œ
  if(mode==="buy") return;

  // ì†Œí™˜: ì†íŒ¨ í´ë¦­ â†’ ë‚´ ë¹ˆ ìŠ¬ë¡¯ í´ë¦­
  if(mode==="summon"){
    if(!isMine) return toast("ë‚´ ìŠ¬ë¡¯ì—ë§Œ ì†Œí™˜");
    if(selHand==null) return toast("ì†íŒ¨ ë¨¼ì € ì„ íƒ");
    if((data.actionLeft??0)<=0) return toast("í–‰ë™ 0");
    if(my.field[idx]) return toast("ì´ë¯¸ ëª¬ìŠ¤í„° ìˆìŒ");
    if((data.lock||{})[`${me}-${idx}`]) return toast("ì ê¹€");

    const card=my.hand[selHand];
    if(!card) return toast("ì†íŒ¨ ì˜¤ë¥˜");

    my.field[idx]={...card, alive:true};
    my.hand.splice(selHand,1);
    data.players[me]=my;
    data.actionLeft-=1;

    await setDoc(ref,data);
    selHand=null;
    toast("ì†Œí™˜!");
    return;
  }

  // ê³µê²©: ë‚´ ëª¬ìŠ¤í„° í´ë¦­ â†’ ìƒëŒ€ ëª¬ìŠ¤í„° or ìƒëŒ€ í”Œë ˆì´ì–´(ìƒëŒ€í•„ë“œ ì œëª© í´ë¦­ ëŒ€ì‹ : ìƒëŒ€ ë¹ˆì¹¸ í´ë¦­ ì‹œ í”Œë ˆì´ì–´ë¡œ ì²˜ë¦¬)
  if(mode==="attack"){
    data.attackedThisTurn=data.attackedThisTurn||[];
    if(data.attackedThisTurn.length>=2) return toast("ê³µê²© 2íšŒ ë");

    if(isMine){
      const a=my.field[idx];
      if(!a) return toast("ê³µê²©ì ì—†ìŒ");
      if(data.attackedThisTurn.includes(a.instId)) return toast("ì´ë¯¸ ê³µê²©í•¨");
      selAttacker=idx;
      toast("ê³µê²©ì ì„ íƒ");
      renderUI(data);
      return;
    }

    // ìƒëŒ€ ìª½ í´ë¦­
    if(selAttacker==null) return toast("ë‚´ ëª¬ìŠ¤í„° ë¨¼ì € ì„ íƒ");
    if(!op) return toast("ìƒëŒ€ ì—†ìŒ");

    const attacker=my.field[selAttacker];
    if(!attacker) return toast("ê³µê²©ì ì‚¬ë¼ì§");
    if(data.attackedThisTurn.includes(attacker.instId)) return toast("ì¤‘ë³µ ê³µê²©");

    // ê°•ì œ ê³µê²© ëŒ€ìƒ(ìˆ™ì£¼ ì§€ë°°ì²´)
    const mustIdx=findForcedTargetIndex(op);
    if(mustIdx!=null && mustIdx!==idx){
      return toast("ìˆ™ì£¼ ì§€ë°°ì²´ë¥¼ ë¨¼ì € ê³µê²©!");
    }

    const target=op.field[idx];

    // ìƒëŒ€ ìŠ¬ë¡¯ì´ ë¹„ì—ˆìœ¼ë©´ â†’ í”Œë ˆì´ì–´ ê³µê²©ìœ¼ë¡œ ì²˜ë¦¬(ì´ë¯¸ì§€ ì¡°ì‘ ìœ ì§€)
    if(!target){
      // í”Œë ˆì´ì–´ í”¼í•´ ê³„ì‚°
      const dr=playerDR(data, opPid);
      const bonus=(my.faction==="virus" && attacker.mark) ? markBonus(op) : 0;
      const dmg=Math.max(1, Math.floor(attacker.atk*(1+bonus)*(1-dr)));

      op.hp -= dmg;

      // í‘œì‹ ë¶€ì—¬(ë°”ì´ëŸ¬ìŠ¤ mark=true)
      if(my.faction==="virus" && attacker.mark){
        op.debuffs=op.debuffs||{};
        op.debuffs.markTurns=2;
      }

      data.players[opPid]=op;
      data.attackedThisTurn.push(attacker.instId);

      if(op.hp<=0){
        data.status="end";
        data.winner=me;
      }

      await setDoc(ref,data);
      selAttacker=null;
      toast(`í”Œë ˆì´ì–´ í”¼í•´ ${dmg}`);
      return;
    }

    // ëª¬ìŠ¤í„° ê³µê²©: ëŒ€ìƒ hp ê°ì†Œ
    target.hp -= attacker.atk;

    // ë°˜ì‚¬(ìˆ™ì£¼ ì§€ë°°ì²´)
    if(target.id==="vH1"){
      const reflect=Math.floor(attacker.atk*0.3);
      attacker.hp -= reflect;
      if(attacker.hp<=0){
        my.field[selAttacker]=null;
        data.lock=data.lock||{};
        data.lock[`${me}-${selAttacker}`]=1;
        toast("ë°˜ì‚¬ë¡œ ê³µê²©ì ì‚¬ë§!");
      }else{
        my.field[selAttacker]=attacker;
      }
    }else{
      my.field[selAttacker]=attacker;
    }

    if(target.hp<=0){
      op.field[idx]=null;
      data.lock=data.lock||{};
      data.lock[`${opPid}-${idx}`]=1;
      toast("ì²˜ì¹˜!");
    }else{
      op.field[idx]=target;
      toast("íƒ€ê²©!");
    }

    data.players[me]=my;
    data.players[opPid]=op;
    data.attackedThisTurn.push(attacker.instId);

    await setDoc(ref,data);
    selAttacker=null;
    return;
  }
}

/* ===== ë²„íŠ¼ ì•¡ì…˜ ===== */
async function buyCard(){
  const {ref,data}=await loadRoom();
  if(!canAct(data)) return toast("ìƒëŒ€ í„´");
  const my=myData(data); if(!my) return;

  // í„´ë‹¹ 1íšŒ êµ¬ë§¤
  data.turnBuy=data.turnBuy||{};
  const key=`${data.turn}-${me}`;
  if(data.turnBuy[key]) return toast("ì´ë²ˆ í„´ êµ¬ë§¤ ì™„ë£Œ");

  const tier=$("tierSel").value;
  const cost=COST[tier];
  if((my.mana||0)<cost) return toast("ë§ˆë‚˜ ë¶€ì¡±");

  const pool=POOL[my.faction][tier];
  const card={...pool[Math.floor(Math.random()*pool.length)]};
  card.cost=cost;
  card.instId=uid();

  my.mana-=cost;
  my.hand.push(card);
  if(my.hand.length>10) my.hand=my.hand.slice(-10);

  data.players[me]=my;
  data.turnBuy[key]=true;

  await setDoc(ref,data);
  toast("êµ¬ë§¤!");
}

async function endTurn(){
  const {ref,data}=await loadRoom();
  if(!canAct(data)) return toast("ìƒëŒ€ í„´");

  const opPid=otherPid(data);
  if(!opPid) return toast("ìƒëŒ€ ì—†ìŒ");

  data.turn += 1;
  data.turnOwner = opPid;

  // 15í„´ ì¢…ë£Œ íŒì •
  if(data.turn > MAX_TURN){
    data.status="end";
    const ps=pids(data);
    const hp0=data.players[ps[0]]?.hp??0;
    const hp1=data.players[ps[1]]?.hp??0;
    data.winner = (hp0===hp1) ? "draw" : (hp0>hp1 ? ps[0] : ps[1]);
    await setDoc(ref,data);
    toast("ê²Œì„ ì¢…ë£Œ");
    return;
  }

  ensureTurnStart(data);
  await setDoc(ref,data);
  toast("í„´ ì¢…ë£Œ");
}

/* ===== ë¡œë¹„ ===== */
$("create").onclick=async ()=>{
  room=rid();
  me=getPid(room);

  await setDoc(doc(db,"rooms",room),{
    host: me,
    status:"lobby",
    turn:1,
    turnOwner:null,
    actionLeft:2,
    attackedThisTurn:[],
    players:{},
    lock:{},
    turnState:{},
    turnBuy:{},
    createdAt:serverTimestamp()
  });

  $("code").value=room;
  $("lobbyInfo").textContent=`ROOM:${room}  me:${me.slice(0,8)}`;
  listen();
};

$("join").onclick=()=>{
  const v=$("code").value.trim().toUpperCase();
  if(!v) return;
  room=v;
  me=getPid(room);
  $("lobbyInfo").textContent=`ROOM:${room}  me:${me.slice(0,8)}`;
  listen();
};

async function chooseFaction(faction){
  const {ref,data}=await loadRoom();
  data.players=data.players||{};
  data.players[me]={
    faction,
    hp:100,
    mana:0,
    field:[null,null,null,null],
    hand:[],
    debuffs:{markTurns:0}
  };
  await setDoc(ref,data);
  toast(faction==="virus"?"ğŸ¦  ì„ íƒ":"ğŸ’‰ ì„ íƒ");
}
$("virus").onclick=()=>chooseFaction("virus");
$("vaccine").onclick=()=>chooseFaction("vaccine");

$("start").onclick=async ()=>{
  const {ref,data}=await loadRoom();
  if(data.host!==me) return toast("í˜¸ìŠ¤íŠ¸ë§Œ ê°€ëŠ¥");

  const ps=pids(data);
  if(ps.length!==2) return toast("í”Œë ˆì´ì–´ 2ëª… í•„ìš”");
  const picked=ps.filter(pid=>!!data.players?.[pid]?.faction).length;
  if(picked!==2) return toast("ë‘˜ ë‹¤ ì§„ì˜ ì„ íƒ í•„ìš”");

  data.status="playing";
  data.turnOwner = ps[Math.floor(Math.random()*2)];
  ensureTurnStart(data);

  await setDoc(ref,data);

  // ê²Œì„ ì…ì¥ & ê¸°ë³¸ ëª¨ë“œ
  setMode("buy");
  toast("ê²Œì„ ì‹œì‘!");
};

/* ===== ëª¨ë“œ/ë²„íŠ¼ ì—°ê²° ===== */
$("modeBuy").onclick=()=>setMode("buy");
$("modeSummon").onclick=()=>setMode("summon");
$("modeAttack").onclick=()=>setMode("attack");
$("buy").onclick=buyCard;
$("endTurn").onclick=endTurn;

/* ===== realtime ===== */
function listen(){
  if(!room) return;
  if(unsub) unsub();

  unsub=onSnapshot(doc(db,"rooms",room), async (snap)=>{
    if(!snap.exists()){
      toast("ë°© ì—†ìŒ");
      return;
    }
    const {ref,data}=await loadRoom();

    // playingì´ë©´ í„´ ì‹œì‘ ë³´ì •(ë™ê¸°í™”)
    if(data.status==="playing"){
      ensureTurnStart(data);
      await setDoc(ref,data);
    }

    // end ì²˜ë¦¬(í† ìŠ¤íŠ¸ë§Œ)
    if(data.status==="end"){
      const w=data.winner;
      const msg = (w==="draw") ? "ë¬´ìŠ¹ë¶€" : (w===me) ? "ìŠ¹ë¦¬!" : "íŒ¨ë°°";
      toast("ê²Œì„ ì¢…ë£Œ: "+msg);
    }

    renderUI(data);
  },(e)=>{
    console.error(e);
    toast("ì—°ê²° ì—ëŸ¬");
  });
}
</script>
<div id="test" style="display:flex;gap:12px;flex-wrap:wrap"></div>

<script>
const imgs = [
  "assets/virus/virus_low_1.png",
  "assets/virus/virus_low_2.png",
  "assets/virus/virus_low_3.png",
  "assets/virus/virus_mid_1.png",
  "assets/virus/virus_mid_2.png",
  "assets/virus/virus_mid_3.png",
  "assets/virus/virus_high_1.png",
  "assets/virus/virus_high_2.png",
  "assets/virus/virus_high_3.png",
];

const t = document.getElementById("test");
imgs.forEach(src=>{
  const img=document.createElement("img");
  img.src=src;
  img.style.width="120px";
  img.style.height="120px";
  img.style.objectFit="contain";
  img.style.border="2px solid #333";
  t.appendChild(img);
});
</script>
<script type="module">
  import { virusMonsters } from "./assets/data/monsters.js";

  const grid = document.getElementById("virusCards");

  function cardHTML(m){
    const atk = (m.atk === null || m.atk === undefined) ? "?" : m.atk;
    const hp  = (m.hp  === null || m.hp  === undefined) ? "?" : m.hp;
    const effect = (m.effect && m.effect.trim()) ? m.effect : "íš¨ê³¼ ë¯¸ì •";

    return `
      <div style="
        background:#fff;border-radius:16px;border:3px solid rgba(0,0,0,.18);
        box-shadow:0 10px 30px rgba(0,0,0,.18);overflow:hidden;cursor:pointer;">
        <div style="height:150px;display:flex;align-items:center;justify-content:center;
          background:linear-gradient(180deg,#f7fbff,#e6f4ff);">
          <img src="${m.image}" alt="${m.name}" style="max-width:92%;max-height:92%;object-fit:contain"
            onerror="this.style.display='none'; this.parentNode.textContent='(ì´ë¯¸ì§€ ì—†ìŒ)';">
        </div>
        <div style="padding:10px 12px 12px;">
          <div style="font-weight:1000;">${m.name}</div>
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;">
            <span style="padding:4px 8px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;font-weight:900;">
              âš” ${atk}
            </span>
            <span style="padding:4px 8px;border-radius:999px;background:#ecfeff;border:1px solid #a5f3fc;font-weight:900;">
              â¤ ${hp}
            </span>
            <span style="padding:4px 8px;border-radius:999px;background:#f3f4f6;border:1px solid #d1d5db;font-weight:900;">
              ${m.tier.toUpperCase()}
            </span>
          </div>
          <div style="margin-top:8px;font-size:12px;opacity:.75;line-height:1.35;">${effect}</div>
        </div>
      </div>
    `;
  }

  // ë Œë”
  grid.innerHTML = virusMonsters.map(cardHTML).join("");

  // í´ë¦­ ì„ íƒ í‘œì‹œ(ì„ íƒ UX)
  let selectedId = null;
  grid.querySelectorAll(":scope > div").forEach((el, idx)=>{
    el.addEventListener("click", ()=>{
      const id = virusMonsters[idx].id;
      selectedId = id;

      grid.querySelectorAll(":scope > div").forEach(x=>{
        x.style.outline = "none";
        x.style.borderColor = "rgba(0,0,0,.18)";
      });
      el.style.outline = "5px solid rgba(255,45,45,.25)";
      el.style.borderColor = "#ff2d2d";
      console.log("selected:", selectedId);
    });
  });
</script>
</body>
</html>
