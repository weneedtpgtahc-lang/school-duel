<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Virus vs Vaccine Duel</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151a22; --line:#2a3242; --text:#e8eefc; --muted:#a9b4cf;
    --good:#26d07c; --bad:#ff5c5c; --gold:#ffd166; --chip:#20283a;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;background:var(--bg);color:var(--text)}
  .hide{display:none!important}
  .app{max-width:1180px;margin:0 auto;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .sp{justify-content:space-between}
  .pill{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:12px;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .btn{
    border:1px solid var(--line); background:linear-gradient(180deg,#1b2230,#141a24);
    color:var(--text); padding:10px 12px;border-radius:12px; font-weight:800; cursor:pointer;
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{border-color:#3a4a70;background:linear-gradient(180deg,#243151,#172137)}
  .btn.good{border-color:#1f6d4a;background:linear-gradient(180deg,#1f6d4a,#134634)}
  .btn.bad{border-color:#7a2d2d;background:linear-gradient(180deg,#7a2d2d,#3a1616)}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  input,select{
    background:#0f1420;border:1px solid var(--line);color:var(--text);
    padding:10px 12px;border-radius:12px;outline:none;
  }

  /* ===== LOBBY (ì´ë¯¸ì§€í’) ===== */
  .lobbyWrap{
    min-height:100vh;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(#6db8ff 0%, #6db8ff 70%, #7a3b1a 70%);
  }
  .lobbyScreen{
    width:380px;height:680px;border-radius:22px;overflow:hidden;position:relative;
    box-shadow:0 18px 60px rgba(0,0,0,.45);
    border:3px solid rgba(255,255,255,.22);
    background:#6db8ff;
  }
  .ground{position:absolute;left:0;right:0;bottom:0;height:96px;
    background:repeating-linear-gradient(45deg,#7a3b1a,#7a3b1a 10px,#8b4513 10px,#8b4513 20px);
  }
  .pipe{position:absolute;bottom:96px;width:56px;height:88px;background:#2ecc71;border-radius:10px 10px 0 0;
    box-shadow:inset 0 0 0 4px rgba(0,0,0,.12);
  }
  .pipe.l{left:44px} .pipe.c{left:calc(50% - 28px);height:118px} .pipe.r{right:44px}
  .qblock{position:absolute;top:56px;left:calc(50% - 38px);width:76px;height:76px;border-radius:10px;
    background:var(--gold);border:7px solid #b8860b;display:flex;align-items:center;justify-content:center;
    font-weight:900;font-size:36px;color:#4b3b00;box-shadow:0 10px 0 rgba(0,0,0,.12);
  }
  .lobbyTitle{position:absolute;top:150px;left:0;right:0;text-align:center;font-weight:900;font-size:22px;color:#fff;
    text-shadow:0 3px 0 rgba(0,0,0,.25);
  }
  .lobbyCard{
    position:absolute;left:20px;right:20px;top:210px;
    background:rgba(255,255,255,.92);border-radius:18px;padding:14px;border:2px solid rgba(0,0,0,.06);
  }
  .lobbyCard .row{justify-content:center}
  .lbtn{
    width:210px;border:none;border-radius:16px;padding:14px 14px;font-size:18px;font-weight:900;cursor:pointer;
    background:#fff;box-shadow:0 6px 0 #c9c9c9;
  }
  .lbtn:active{transform:translateY(4px);box-shadow:0 2px 0 #c9c9c9}
  .linput{width:210px;border:none;border-radius:14px;padding:12px;text-align:center;font-size:16px}
  .lflex{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.08);font-size:12px}
  .lmini{
    width:150px;border:none;border-radius:16px;padding:12px;font-size:15px;font-weight:900;cursor:pointer;
    background:#fff;box-shadow:0 6px 0 #c9c9c9;
  }
  .lmini:active{transform:translateY(4px);box-shadow:0 2px 0 #c9c9c9}
  .lhost{
    width:320px;border:none;border-radius:16px;padding:12px;font-size:15px;font-weight:900;cursor:pointer;
    background:#111;color:#fff;box-shadow:0 6px 0 #000;
  }
  .lhost:active{transform:translateY(4px);box-shadow:0 2px 0 #000}
  .lsub{margin-top:10px;text-align:center;font-size:12px;color:#334}
  .lsub strong{color:#111}

  /* ===== GAME (ì´ë¯¸ì§€ ì¡°ì‘ UI) ===== */
  .topbar{
    position:sticky;top:0;z-index:10;
    background:rgba(15,17,21,.92);backdrop-filter:blur(8px);
    border:1px solid var(--line);border-radius:16px;padding:10px 12px;margin-bottom:10px;
  }
  .hpbar{width:160px;height:10px;border-radius:999px;background:#222;border:1px solid var(--line);overflow:hidden}
  .hpfill{height:100%;background:linear-gradient(90deg,#26d07c,#6ef3b1)}
  .hpfill.bad{background:linear-gradient(90deg,#ff5c5c,#ff9a9a)}
  .iconBtn{
    width:44px;height:44px;border-radius:14px;border:1px solid var(--line);
    background:linear-gradient(180deg,#1b2230,#141a24);
    display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;
  }
  .iconBtn:active{transform:translateY(1px)}
  .iconBtn[disabled]{opacity:.45;cursor:not-allowed}
  .panel{
    border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:12px;margin:10px 0;
  }

  .board{
    display:grid;gap:10px;
    grid-template-columns:1fr;
  }
  .laneTitle{display:flex;align-items:center;justify-content:space-between;margin:0 0 6px}
  .laneTitle span{color:var(--muted);font-size:12px}
  .field{
    display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:10px;
  }
  @media (max-width: 860px){
    .field{grid-template-columns:repeat(2,minmax(160px,1fr))}
  }

  .slot{
    position:relative;border:1px dashed #3a4660;border-radius:16px;background:linear-gradient(180deg,#101522,#0d111b);
    min-height:250px;overflow:hidden;
  }
  .slotHdr{
    position:absolute;left:8px;right:8px;top:8px;
    display:flex;justify-content:space-between;gap:6px;align-items:center;
    pointer-events:none;
  }
  .badge{padding:4px 8px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.08);font-size:12px;color:#cfe1ff}
  .badge.lock{color:#ffd0d0}
  .overlay{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.55);font-weight:900;font-size:16px;color:#fff;
  }

  .card{
    height:100%;display:flex;flex-direction:column;
    border:1px solid #263049;border-radius:16px;overflow:hidden;background:#0c111c;
    cursor:pointer;
  }
  .card.selected{outline:3px solid #fff}
  .thumb{width:100%;height:160px;object-fit:cover;background:#1a2333}
  .meta{padding:10px;display:flex;flex-direction:column;gap:8px}
  .name{font-weight:900;font-size:14px}
  .stats{display:flex;gap:8px;flex-wrap:wrap}
  .chip2{padding:4px 8px;border-radius:999px;background:#141d2e;border:1px solid #263049;font-size:12px;color:#cfe1ff}
  .chip2.mark{color:#d6ff8a}
  .fx{font-size:12px;color:var(--muted);line-height:1.35;min-height:30px}
  .emptyHint{
    height:100%;display:flex;align-items:center;justify-content:center;color:#5f6b84;font-weight:800;
  }

  .hand{
    display:flex;gap:10px;overflow:auto;padding-bottom:6px;
    scroll-snap-type:x mandatory;
  }
  .hcard{min-width:180px;scroll-snap-align:start}
  .toast{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:16px;max-width:min(680px, 92vw);
    background:rgba(0,0,0,.72);backdrop-filter:blur(6px);
    border:1px solid rgba(255,255,255,.14);color:#fff;
    padding:10px 12px;border-radius:999px;font-size:13px;
  }
</style>
</head>

<body>

<!-- ===== LOBBY ===== -->
<div id="lobby" class="lobbyWrap">
  <div class="lobbyScreen">
    <div class="qblock">!</div>
    <div class="lobbyTitle">Virus vs Vaccine Duel</div>

    <div class="lobbyCard">
      <div class="row" style="margin-top:4px">
        <button id="create" class="lbtn">ë°© ë§Œë“¤ê¸°</button>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="code" class="linput" placeholder="ë°© ì½”ë“œ ì…ë ¥" />
      </div>
      <div class="row" style="margin-top:10px">
        <button id="join" class="lbtn">ë°© ì°¸ê°€</button>
      </div>

      <div class="lflex">
        <span id="conn" class="chip">â— <span class="mono">OFF</span></span>
        <span id="info" class="chip mono"></span>
        <span id="meTag" class="chip mono"></span>
      </div>

      <div class="lflex" style="margin-top:12px">
        <button id="virus" class="lmini">ë°”ì´ëŸ¬ìŠ¤</button>
        <button id="vaccine" class="lmini">ë°±ì‹ </button>
      </div>
      <div class="row" style="margin-top:10px;justify-content:center">
        <button id="start" class="lhost hide">ê²Œì„ ì‹œì‘(í˜¸ìŠ¤íŠ¸)</button>
      </div>
      <div id="lobbyStatus" class="lsub">
        ì°¸ê°€ <strong>0/2</strong> Â· ì§„ì˜ì„ íƒ <strong>0/2</strong>
      </div>
      <div class="lsub" style="margin-top:8px">
        í˜¸ìŠ¤íŠ¸ë§Œ ì‹œì‘ ë²„íŠ¼ í‘œì‹œ Â· 2ëª… ëª¨ë‘ ì§„ì˜ ì„ íƒ í›„ ì‹œì‘
      </div>
    </div>

    <div class="pipe l"></div><div class="pipe c"></div><div class="pipe r"></div>
    <div class="ground"></div>
  </div>
</div>

<!-- ===== GAME ===== -->
<div id="game" class="app hide">
  <div class="topbar">
    <div class="row sp">
      <div class="row">
        <span id="turnPill" class="pill">TURN -/-</span>
        <span id="youPill" class="pill">YOU</span>
        <span id="roomPill" class="pill mono">ROOM: -</span>
      </div>
      <div class="row">
        <div class="row" style="gap:8px">
          <span class="pill">HP</span>
          <div class="hpbar"><div id="hpFill" class="hpfill" style="width:100%"></div></div>
          <span id="hpText" class="pill">100</span>
        </div>
        <span id="manaPill" class="pill">MANA 0</span>
        <span id="actPill" class="pill">ACT 0/2</span>
        <span id="atkPill" class="pill">ATK 0/2</span>
        <button id="endTurn" class="btn primary">í„´ ì¢…ë£Œ</button>
      </div>
    </div>

    <div class="row sp" style="margin-top:8px">
      <div class="row">
        <button id="modeBuy" class="iconBtn" title="êµ¬ë§¤">ğŸ›’</button>
        <button id="modeSummon" class="iconBtn" title="ì†Œí™˜">ğŸ§¬</button>
        <button id="modeAttack" class="iconBtn" title="ê³µê²©">âš”ï¸</button>
        <span id="modePill" class="pill">MODE: ğŸ›’</span>
        <span id="helpPill" class="pill">ì†íŒ¨ í´ë¦­ â†’ ìŠ¬ë¡¯ í´ë¦­</span>
      </div>
      <div class="row">
        <select id="tierSel">
          <option value="low">í•˜ê¸‰(2)</option>
          <option value="mid">ì¤‘ê¸‰(5)</option>
          <option value="high">ìƒê¸‰(9)</option>
        </select>
        <button id="buy" class="btn good">êµ¬ë§¤</button>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="board">
      <div>
        <div class="laneTitle"><strong>ìƒëŒ€ í•„ë“œ</strong><span id="opMark" class="pill">í‘œì‹: 0</span></div>
        <div id="opField" class="field"></div>
      </div>

      <div>
        <div class="laneTitle"><strong>ë‚´ í•„ë“œ</strong><span id="myDR" class="pill">í”¼ê°: 0%</span></div>
        <div id="myField" class="field"></div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="laneTitle"><strong>ë‚´ ì†íŒ¨</strong><span id="handCount" class="pill">0/10</span></div>
    <div id="hand" class="hand"></div>
  </div>

  <div class="panel">
    <div class="laneTitle"><strong>ë””ë²„ê·¸</strong><span class="pill">í•„ìš” ì—†ìœ¼ë©´ ìˆ¨ê²¨ë„ ë¨</span></div>
    <pre id="state" style="margin:0;background:#0b0f18;border:1px solid #24304a;color:#cfe1ff;border-radius:14px;padding:10px;max-height:220px;overflow:auto"></pre>
  </div>
</div>

<div id="toast" class="toast hide"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* âœ… Firebase ì„¤ì •(ë„¤ ê°’) */
const firebaseConfig = {
  apiKey: "AIzaSyBIZll4u_E6zHKyoJZqjCI6_P9cxhK1Shs",
  authDomain: "yanngok-9323a.firebaseapp.com",
  projectId: "yanngok-9323a",
  storageBucket: "yanngok-9323a.firebasestorage.app",
  messagingSenderId: "433037582784",
  appId: "1:433037582784:web:43d77ca2530126240a2825",
  measurementId: "G-M51E2S8PQF"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const $ = (id)=>document.getElementById(id);
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const rid=()=>Math.random().toString(36).slice(2,8).toUpperCase();
const uid=()=>Math.random().toString(36).slice(2,10);

let room=null, me=null, unsub=null;

const COST={low:2,mid:5,high:9};
const MAX_TURN=15;

/* ===== ì´ë¯¸ì§€ ê²½ë¡œ(ë°”ì´ëŸ¬ìŠ¤ 9ì¥) ===== */
const VIRUS_IMAGES = {
  low:  ["assets/virus/v_low_1.webp","assets/virus/v_low_2.jpg","assets/virus/v_low_3.webp"],
  mid:  ["assets/virus/v_mid_1.webp","assets/virus/v_mid_2.webp","assets/virus/v_mid_3.webp"],
  high: ["assets/virus/v_high_1.webp","assets/virus/v_high_2.jpg","assets/virus/v_high_3.webp"],
};

/* ===== ëª¬ìŠ¤í„° ë°ì´í„°(í™•ì •í‘œ) ===== */
const POOL={
  virus:{
    low:[
      {id:"vL1",name:"ì¹¨íˆ¬ í¬ì",tier:"low",atk:7,hp:16,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:VIRUS_IMAGES.low[0]},
      {id:"vL2",name:"ë³µì œ ì„¸í¬",tier:"low",atk:6,hp:18,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:VIRUS_IMAGES.low[1]},
      {id:"vL3",name:"ì ì•¡ ë¶„ì—´ì²´",tier:"low",atk:8,hp:14,mark:true, effect:"í”Œë ˆì´ì–´ ê³µê²© ì‹œ í‘œì‹(2í„´) ë¶€ì—¬",img:VIRUS_IMAGES.low[2]},
    ],
    mid:[
      {id:"vM1",name:"ê°ì—¼ í™•ì‚°ì²´",tier:"mid",atk:6,hp:32,mark:false,effect:"íš¨ê³¼ ì—†ìŒ (íƒ±ì»¤)",img:VIRUS_IMAGES.mid[0]},
      {id:"vM2",name:"ë³€ì´ ëŒê²©ì²´",tier:"mid",atk:11,hp:22,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:VIRUS_IMAGES.mid[1]},
      {id:"vM3",name:"ì€í ì ë³µì²´",tier:"mid",atk:8,hp:28,mark:true, effect:"í”Œë ˆì´ì–´ ê³µê²© ì‹œ í‘œì‹(2í„´) ë¶€ì—¬",img:VIRUS_IMAGES.mid[2]},
    ],
    high:[
      {id:"vH1",name:"ìˆ™ì£¼ ì§€ë°°ì²´",tier:"high",atk:9,hp:48,mark:false,effect:"ê°•ì œ ê³µê²© ëŒ€ìƒ / ë°›ì€ í”¼í•´ì˜ 30% ë°˜ì‚¬",img:VIRUS_IMAGES.high[1]},
      {id:"vH2",name:"ì‹ ê²½ ì˜¤ì—¼ì²´",tier:"high",atk:14,hp:34,mark:true, effect:"í”Œë ˆì´ì–´ ê³µê²© ì‹œ í‘œì‹(2í„´) ë¶€ì—¬",img:VIRUS_IMAGES.high[0]},
      {id:"vH3",name:"ì¬ì•™ êµ°ì²´í•µ",tier:"high",atk:10,hp:52,mark:false,effect:"íš¨ê³¼ ì—†ìŒ (ì´ˆê³ ì²´ë ¥)",img:VIRUS_IMAGES.high[2]},
    ],
  },
  vaccine:{
    low:[
      {id:"cL1",name:"ì£¼ì‚¬ë³‘",tier:"low",atk:6,hp:18,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:""},
      {id:"cL2",name:"ì†Œë… ìš”ì›",tier:"low",atk:7,hp:16,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:""},
      {id:"cL3",name:"ë°©ì—­ ë“œë¡ ",tier:"low",atk:5,hp:20,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:""},
    ],
    mid:[
      {id:"cM1",name:"í•­ì²´ ë°©íŒ¨ë³‘",tier:"mid",atk:7,hp:30,mark:false,effect:"íš¨ê³¼ ì—†ìŒ(íƒ±ì»¤)",img:""},
      {id:"cM2",name:"ë©´ì—­ ìˆ˜í˜¸ì",tier:"mid",atk:10,hp:24,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:""},
      {id:"cM3",name:"ì •í™” ê³µë³‘",tier:"mid",atk:9,hp:26,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:""},
    ],
    high:[
      {id:"cH1",name:"ë©´ì—­ ì‚¬ë ¹ê´€",tier:"high",atk:12,hp:44,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:""},
      {id:"cH2",name:"ë°±ì‹  ë°°ì–‘ì²´",tier:"high",atk:9,hp:52,mark:false,effect:"íš¨ê³¼ ì—†ìŒ(ìµœê³  ì²´ë ¥)",img:""},
      {id:"cH3",name:"í•­ì› ì œì••ê¸°",tier:"high",atk:14,hp:40,mark:false,effect:"íš¨ê³¼ ì—†ìŒ",img:""},
    ],
  }
};

const tierLabel=(t)=>t==="low"?"í•˜ê¸‰":t==="mid"?"ì¤‘ê¸‰":"ìƒê¸‰";
const fallbackImg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='520' height='360'%3E%3Crect width='100%25' height='100%25' fill='%231a2333'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23cfe1ff' font-size='22'%3ENo Image%3C/text%3E%3C/svg%3E";

/* ===== UI ì¡°ì‘ ìƒíƒœ ===== */
let mode="buy"; // buy | summon | attack
let selHand=null;       // index
let selMySlot=null;     // 0..3 (ì†Œí™˜ ìŠ¬ë¡¯)
let selAttacker=null;   // my slot index (ê³µê²©ì)
let selTarget=null;     // "P" or {type:"S", idx}

/* ===== Helpers ===== */
function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.classList.remove("hide");
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.classList.add("hide"), 1400);
}
function setConn(text, ok=false, bad=false){
  const c=$("conn");
  c.innerHTML = "â— <span class='mono'>"+text+"</span>";
  c.style.color = ok? "#0a7" : bad? "#b00" : "#111";
}
function getPid(r){
  const k="vvd_pid_"+r;
  let v=localStorage.getItem(k);
  if(!v){ v=crypto.randomUUID(); localStorage.setItem(k,v); }
  return v;
}
async function loadRoom(){
  if(!room) throw new Error("no room");
  const ref=doc(db,"rooms",room);
  const snap=await getDoc(ref);
  if(!snap.exists()) throw new Error("no room");
  return {ref,data:snap.data()};
}
const pids=(d)=>Object.keys(d.players||{});
const otherPid=(d)=>pids(d).find(pid=>pid!==me)||null;
const myData=(d)=>d.players?.[me]||null;
const opData=(d)=>{const op=otherPid(d); return op?d.players[op]:null;};
const aliveCount=(field)=>(field||[]).filter(x=>x && x.alive!==false).length;

function playerDR(d,pid){
  const p=d.players?.[pid]; if(!p) return 0;
  const base=0.2*aliveCount(p.field);
  const bonus=(p.faction==="vaccine")?0.2:0;
  return clamp(base+bonus,0,0.8);
}
const markBonus=(p)=>((p?.debuffs?.markTurns||0)>0 ? 0.15 : 0);
const canAct=(d)=>d.status==="playing" && d.turnOwner===me;

function ensureTurnStart(d){
  d.turnState=d.turnState||{};
  const k=`${d.turn}-${d.turnOwner}`;
  if(d.turnState.startedKey===k) return;

  const p=d.players?.[d.turnOwner];
  if(p){
    p.mana=(p.mana||0)+3;
    d.actionLeft=2;
    d.attackedThisTurn=[];
    p.debuffs=p.debuffs||{};
    if(p.debuffs.markTurns) p.debuffs.markTurns=Math.max(0, p.debuffs.markTurns-1);

    d.lock=d.lock||{};
    for(let s=0;s<4;s++){
      const lk=`${d.turnOwner}-${s}`;
      if(d.lock[lk] && d.lock[lk]>0) d.lock[lk]-=1;
      if(d.lock[lk]===0) delete d.lock[lk];
    }
  }
  d.turnState.startedKey=k;
}

/* ===== Render cards ===== */
function cardNode(m, extra=""){
  const div=document.createElement("div");
  div.className="card";
  div.innerHTML=`
    <img class="thumb" src="${(m.img&&m.img.trim())?m.img:fallbackImg}" alt="">
    <div class="meta">
      <div class="name">${m.name}</div>
      <div class="stats">
        <span class="chip2">âš” ${m.atk}</span>
        <span class="chip2">â¤ ${m.hp}</span>
        ${m.mark? `<span class="chip2 mark">â˜£ í‘œì‹</span>` : ``}
        <span class="chip2">${tierLabel(m.tier)}</span>
        ${extra}
      </div>
      <div class="fx">${m.effect||"íš¨ê³¼ ì—†ìŒ"}</div>
    </div>
  `;
  return div;
}

function setMode(m){
  mode=m;
  $("modePill").textContent = "MODE: " + (m==="buy"?"ğŸ›’":m==="summon"?"ğŸ§¬":"âš”ï¸");
  $("helpPill").textContent =
    m==="buy" ? "êµ¬ë§¤ ë²„íŠ¼ìœ¼ë¡œ ì¹´ë“œ ë½‘ê¸°" :
    m==="summon" ? "ì†íŒ¨ í´ë¦­ â†’ ë‚´ ìŠ¬ë¡¯ í´ë¦­(ì†Œí™˜)" :
    "ë‚´ ëª¬ìŠ¤í„° í´ë¦­ â†’ ìƒëŒ€(ëª¬ìŠ¤í„°/í”Œë ˆì´ì–´) í´ë¦­(ê³µê²©)";
  toast(m==="buy"?"êµ¬ë§¤ ëª¨ë“œ":m==="summon"?"ì†Œí™˜ ëª¨ë“œ":"ê³µê²© ëª¨ë“œ");
  selHand=null; selMySlot=null; selAttacker=null; selTarget=null;
}

/* ===== UI: Fields/Hand ===== */
function renderUI(d){
  $("state").textContent = JSON.stringify(d,null,2);

  // view switch
  $("lobby").classList.toggle("hide", d.status!=="lobby");
  $("game").classList.toggle("hide", d.status==="lobby");

  // lobby
  if(d.status==="lobby"){
    const ps=pids(d);
    const picked=ps.filter(pid=>!!d.players?.[pid]?.faction).length;
    const isHost=(d.host===me);
    $("lobbyStatus").innerHTML = `ì°¸ê°€ <strong>${ps.length}/2</strong> Â· ì§„ì˜ì„ íƒ <strong>${picked}/2</strong>${isHost?" Â· <strong>í˜¸ìŠ¤íŠ¸</strong>":""}`;
    $("start").classList.toggle("hide", !(isHost));
    $("info").textContent = room?("ROOM: "+room):"";
    $("meTag").textContent = me?("me:"+me.slice(0,8)):"";
    return;
  }

  // topbar
  const my=myData(d), op=opData(d), opPid=otherPid(d);
  $("roomPill").textContent="ROOM: "+(room||"-");
  $("turnPill").textContent=`TURN ${d.turn}/${MAX_TURN} Â· ${(d.turnOwner===me)?"ë‚´ í„´":"ìƒëŒ€ í„´"}`;
  $("youPill").textContent = my?.faction==="virus" ? "YOU: ğŸ¦ " : "YOU: ğŸ’‰";

  const hp=my?.hp ?? 0;
  $("hpText").textContent=String(hp);
  const w=clamp(hp,0,100);
  $("hpFill").style.width=w+"%";
  $("hpFill").classList.toggle("bad", w<35);

  $("manaPill").textContent="MANA "+(my?.mana ?? 0);
  $("actPill").textContent="ACT "+(d.actionLeft ?? 0)+"/2";
  $("atkPill").textContent="ATK "+((d.attackedThisTurn?.length)||0)+"/2";

  const dr=playerDR(d, me);
  $("myDR").textContent = `í”¼ê°: ${Math.round(dr*100)}%`;
  $("opMark").textContent = `í‘œì‹: ${op?.debuffs?.markTurns||0}`;

  // buttons enable
  const enabled = canAct(d);
  $("buy").disabled = !enabled;
  $("endTurn").disabled = !enabled;
  $("modeBuy").disabled = !enabled;
  $("modeSummon").disabled = !enabled;
  $("modeAttack").disabled = !enabled;

  // field render
  renderFieldSide("myField", d, me, true);
  if(opPid) renderFieldSide("opField", d, opPid, false);

  // hand render
  renderHand(d);
  $("handCount").textContent = `${(my?.hand||[]).length}/10`;
}

function renderFieldSide(containerId, d, pid, isMine){
  const cont=$(containerId);
  cont.innerHTML="";
  const p=d.players?.[pid];
  const lock=d.lock||{};
  for(let i=0;i<4;i++){
    const lk=`${pid}-${i}`;
    const lockedTurns=lock[lk]||0;
    const m=p?.field?.[i]||null;

    const slot=document.createElement("div");
    slot.className="slot";
    slot.dataset.slot=String(i);
    slot.dataset.side=isMine?"my":"op";

    const hdr=document.createElement("div");
    hdr.className="slotHdr";
    hdr.innerHTML=`
      <span class="badge">${isMine?"ë‚´":"ìƒëŒ€"} ${i}</span>
      ${lockedTurns? `<span class="badge lock">ì ê¹€ ${lockedTurns}</span>` : ``}
    `;
    slot.appendChild(hdr);

    if(m){
      const node=cardNode(m);
      if(isMine && selAttacker===i && mode==="attack") node.classList.add("selected");
      slot.appendChild(node);
    }else{
      const e=document.createElement("div");
      e.className="emptyHint";
      e.textContent="EMPTY";
      slot.appendChild(e);
    }

    if(lockedTurns){
      const ov=document.createElement("div");
      ov.className="overlay";
      ov.textContent="LOCKED";
      slot.appendChild(ov);
    }

    // click handling (ì´ë¯¸ì§€ í´ë¦­ ì¡°ì‘)
    slot.addEventListener("click", async ()=>{
      const {ref,data}=await loadRoom();

      if(data.status!=="playing") return;
      if(!canAct(data)) return toast("ìƒëŒ€ í„´");

      if(isMine){
        // ë‚´ ìŠ¬ë¡¯ í´ë¦­
        if(mode==="summon"){
          // ì†íŒ¨ ì„ íƒ + ë¹ˆì¹¸ + ì ê¹€X
          if(selHand==null) return toast("ì†íŒ¨ ë¨¼ì € ì„ íƒ");
          const my=myData(data);
          if(!my) return;
          if((data.actionLeft??0)<=0) return toast("í–‰ë™ 0");
          if(my.field[i]) return toast("ì´ë¯¸ ìˆìŒ");
          if((data.lock||{})[`${me}-${i}`]) return toast("ì ê¹€");

          const card=my.hand[selHand];
          if(!card) return toast("ì†íŒ¨ ì˜¤ë¥˜");
          my.field[i]={...card, alive:true};
          my.hand.splice(selHand,1);
          data.players[me]=my;
          data.actionLeft-=1;
          await setDoc(ref,data);
          selHand=null;
          toast("ì†Œí™˜!");
          return;
        }

        if(mode==="attack"){
          // ê³µê²©ì ì„ íƒ
          const my=myData(data);
          const a=my?.field?.[i];
          if(!a) return toast("ê³µê²©ì ì—†ìŒ");
          if((data.attackedThisTurn||[]).includes(a.instId)) return toast("ì´ë¯¸ ê³µê²©í•¨");
          selAttacker=i;
          toast("ê³µê²©ì ì„ íƒ");
          await setDoc(ref,data); // ìƒíƒœ ë™ê¸°í™”(ì„ íƒì€ ë¡œì»¬ì´ì§€ë§Œ UI ê°±ì‹ ìš©)
          return;
        }
      }else{
        // ìƒëŒ€ ìŠ¬ë¡¯ í´ë¦­ (ëŒ€ìƒ ì„ íƒ/ê³µê²©)
        if(mode!=="attack") return;
        if(selAttacker==null) return toast("ë‚´ ëª¬ìŠ¤í„°ë¶€í„° ì„ íƒ");

        const my=myData(data);
        const opPid=otherPid(data);
        const op=opPid?data.players[opPid]:null;
        if(!my||!op) return;

        // ê°•ì œ ê³µê²© ëŒ€ìƒ ì²´í¬(ìˆ™ì£¼ ì§€ë°°ì²´)
        const mustIdx = findForcedTargetIndex(op);
        if(mustIdx!=null && mustIdx!==i){
          return toast("ìˆ™ì£¼ ì§€ë°°ì²´ë¥¼ ë¨¼ì € ê³µê²©!");
        }

        const attacker=my.field?.[selAttacker];
        if(!attacker) return toast("ê³µê²©ì ì‚¬ë¼ì§");

        if((data.attackedThisTurn||[]).length>=2) return toast("ê³µê²© 2íšŒ ë");
        if((data.attackedThisTurn||[]).includes(attacker.instId)) return toast("ì¤‘ë³µ ê³µê²©");

        const target=op.field?.[i];
        if(!target) return toast("ë¹ˆì¹¸");

        // ëª¬ìŠ¤í„° â†” ëª¬ìŠ¤í„° ì „íˆ¬(ë‹¨ìˆœ: attacker.atk ë§Œí¼ ëŒ€ìƒ hp ê°ì†Œ)
        target.hp -= attacker.atk;

        // ë°˜ì‚¬(ìˆ™ì£¼ ì§€ë°°ì²´)
        if(target.id==="vH1"){ // ìˆ™ì£¼ ì§€ë°°ì²´
          const reflect=Math.floor(attacker.atk*0.3);
          attacker.hp -= reflect;
          if(attacker.hp<=0){
            my.field[selAttacker]=null;
            data.lock=data.lock||{};
            data.lock[`${me}-${selAttacker}`]=1;
            toast("ê³µê²©ì ë°˜ì‚¬ë¡œ ì‚¬ë§!");
          }else{
            my.field[selAttacker]=attacker;
          }
        }else{
          my.field[selAttacker]=attacker;
        }

        if(target.hp<=0){
          op.field[i]=null;
          data.lock=data.lock||{};
          data.lock[`${opPid}-${i}`]=1;
          toast("ì²˜ì¹˜!");
        }else{
          op.field[i]=target;
          toast("íƒ€ê²©!");
        }

        data.players[me]=my;
        data.players[opPid]=op;
        data.attackedThisTurn=(data.attackedThisTurn||[]);
        data.attackedThisTurn.push(attacker.instId);

        await setDoc(ref,data);
        selAttacker=null;
        return;
      }
    });

    cont.appendChild(slot);
  }
}

function renderHand(d){
  const cont=$("hand");
  cont.innerHTML="";
  const my=myData(d);
  const hand=my?.hand||[];

  hand.forEach((c, idx)=>{
    const wrap=document.createElement("div");
    wrap.className="hcard";
    const node=cardNode(c, `<span class="chip2">#${idx}</span>`);
    if(mode==="summon" && selHand===idx) node.classList.add("selected");
    wrap.appendChild(node);

    wrap.addEventListener("click", ()=>{
      if(mode!=="summon") return toast("ì†Œí™˜ ëª¨ë“œ(ğŸ§¬)ë¡œ ë°”ê¾¸ê¸°");
      selHand=idx;
      toast("ì†íŒ¨ ì„ íƒ");
      // UIë§Œ ê°±ì‹ 
      renderUI(lastData);
    });

    cont.appendChild(wrap);
  });
}

/* ===== Special rules ===== */
function findForcedTargetIndex(opPlayer){
  // ìƒëŒ€ í•„ë“œì— ìˆ™ì£¼ ì§€ë°°ì²´(vH1)ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ë¨¼ì € ë•Œë ¤ì•¼ í•¨
  for(let i=0;i<4;i++){
    const m=opPlayer?.field?.[i];
    if(m && m.id==="vH1") return i;
  }
  return null;
}

/* ===== Actions ===== */
async function buyCard(){
  const {ref,data}=await loadRoom();
  if(!canAct(data)) return toast("ìƒëŒ€ í„´");
  const my=myData(data);
  if(!my) return;

  data.turnBuy=data.turnBuy||{};
  const key=`${data.turn}-${me}`;
  if(data.turnBuy[key]) return toast("ì´ë²ˆ í„´ êµ¬ë§¤ ì™„ë£Œ");

  const tier=$("tierSel").value;
  const cost=COST[tier];
  if((my.mana||0)<cost) return toast("ë§ˆë‚˜ ë¶€ì¡±");

  const pool=POOL[my.faction][tier];
  const card={...pool[Math.floor(Math.random()*pool.length)]};
  card.cost=cost;
  card.instId=uid();
  my.mana-=cost;
  my.hand.push(card);
  if(my.hand.length>10) my.hand=my.hand.slice(-10);

  data.players[me]=my;
  data.turnBuy[key]=true;

  await setDoc(ref,data);
  toast("êµ¬ë§¤!");
}

async function endTurn(){
  const {ref,data}=await loadRoom();
  if(!canAct(data)) return toast("ìƒëŒ€ í„´");
  const opPid=otherPid(data);
  if(!opPid) return toast("ìƒëŒ€ ì—†ìŒ");

  data.turn+=1;
  data.turnOwner=opPid;

  if(data.turn>MAX_TURN){
    data.status="end";
    const ps=pids(data);
    const hp0=data.players[ps[0]]?.hp??0;
    const hp1=data.players[ps[1]]?.hp??0;
    data.winner=(hp0===hp1)?"draw":(hp0>hp1?ps[0]:ps[1]);
    await setDoc(ref,data);
    return;
  }

  ensureTurnStart(data);
  await setDoc(ref,data);
  toast("í„´ ì¢…ë£Œ");
}

/* ===== Player attack by clicking opponent top area (í”Œë ˆì´ì–´ íƒ€ê²©) ===== */
function bindPlayerAttackZones(){
  // ìƒëŒ€ í•„ë“œ ì œëª© í´ë¦­ = í”Œë ˆì´ì–´ ê³µê²© ì‹œë„(ì´ë¯¸ì§€ ì¡°ì‘ ëŠë‚Œ ìœ ì§€)
  $("opMark").addEventListener("click", async ()=>{
    const {ref,data}=await loadRoom();
    if(data.status!=="playing") return;
    if(!canAct(data)) return toast("ìƒëŒ€ í„´");
    if(mode!=="attack") return toast("ê³µê²© ëª¨ë“œ(âš”ï¸)");
    if(selAttacker==null) return toast("ë‚´ ëª¬ìŠ¤í„° ë¨¼ì € ì„ íƒ");

    const my=myData(data);
    const opPid=otherPid(data);
    const op=opPid?data.players[opPid]:null;
    if(!my||!op) return;

    // ê°•ì œ ê³µê²© ëŒ€ìƒ
    const mustIdx=findForcedTargetIndex(op);
    if(mustIdx!=null) return toast("ìˆ™ì£¼ ì§€ë°°ì²´ë¥¼ ë¨¼ì € ê³µê²©!");

    const a=my.field?.[selAttacker];
    if(!a) return toast("ê³µê²©ì ì—†ìŒ");
    if((data.attackedThisTurn||[]).length>=2) return toast("ê³µê²© 2íšŒ ë");
    if((data.attackedThisTurn||[]).includes(a.instId)) return toast("ì¤‘ë³µ ê³µê²©");

    const dr=playerDR(data, opPid);
    const bonus=(my.faction==="virus" && a.mark) ? markBonus(op) : 0;
    const dmg=Math.max(1, Math.floor(a.atk*(1+bonus)*(1-dr)));

    op.hp -= dmg;

    // í‘œì‹ ë¶€ì—¬(ë°”ì´ëŸ¬ìŠ¤ + mark=true)
    if(my.faction==="virus" && a.mark){
      op.debuffs=op.debuffs||{};
      op.debuffs.markTurns=2;
    }

    data.players[opPid]=op;
    data.attackedThisTurn=(data.attackedThisTurn||[]);
    data.attackedThisTurn.push(a.instId);

    if(op.hp<=0){
      data.status="end";
      data.winner=me;
    }

    await setDoc(ref,data);
    selAttacker=null;
    toast("í”Œë ˆì´ì–´ íƒ€ê²©!");
  });
}

/* ===== realtime ===== */
let lastData=null;
function listen(){
  if(!room) return;
  if(unsub) unsub();

  unsub=onSnapshot(doc(db,"rooms",room), async (snap)=>{
    if(!snap.exists()){ setConn("NO", false, true); return; }
    const {ref,data}=await loadRoom();

    if(data.status==="playing"){
      ensureTurnStart(data);
      await setDoc(ref,data);
    }

    lastData=data;
    setConn("ON", true, false);
    $("info").textContent = room?("ROOM: "+room):"";
    $("meTag").textContent = me?("me:"+me.slice(0,8)):"";

    renderUI(data);

    // end screen ê°„ë‹¨ ì²˜ë¦¬(ì´ë¯¸ì§€ ìœ„ì£¼ë¼ í…ìŠ¤íŠ¸ ìµœì†Œ)
    if(data.status==="end"){
      const w=data.winner;
      const msg = (w==="draw") ? "ë¬´ìŠ¹ë¶€" : (w===me) ? "ìŠ¹ë¦¬!" : "íŒ¨ë°°";
      toast("ê²Œì„ ì¢…ë£Œ: "+msg);
    }
  },(e)=>{
    setConn("ERR", false, true);
    console.error(e);
  });
}

/* ===== Lobby actions ===== */
$("create").onclick=async ()=>{
  room=rid();
  me=getPid(room);

  await setDoc(doc(db,"rooms",room),{
    host: me,
    status:"lobby",
    turn:1,
    turnOwner:null,
    actionLeft:2,
    attackedThisTurn:[],
    players:{},
    lock:{},
    turnState:{},
    turnBuy:{},
    createdAt:serverTimestamp()
  });

  $("code").value=room;
  $("info").textContent="ROOM: "+room;
  $("meTag").textContent="me:"+me.slice(0,8);
  listen();
};

$("join").onclick=()=>{
  const v=$("code").value.trim().toUpperCase();
  if(!v) return;
  room=v;
  me=getPid(room);
  $("info").textContent="ROOM: "+room;
  $("meTag").textContent="me:"+me.slice(0,8);
  listen();
};

async function chooseFaction(faction){
  const {ref,data}=await loadRoom();
  data.players=data.players||{};
  data.players[me]={
    faction,
    hp:100,
    mana:0,
    field:[null,null,null,null],
    hand:[],
    debuffs:{markTurns:0}
  };
  await setDoc(ref,data);
  toast(faction==="virus"?"ğŸ¦  ì„ íƒ":"ğŸ’‰ ì„ íƒ");
}
$("virus").onclick=()=>chooseFaction("virus");
$("vaccine").onclick=()=>chooseFaction("vaccine");

$("start").onclick=async ()=>{
  const {ref,data}=await loadRoom();
  if(data.host!==me) return toast("í˜¸ìŠ¤íŠ¸ë§Œ");
  const ps=pids(data);
  if(ps.length!==2) return toast("2ëª… í•„ìš”");
  const picked=ps.filter(pid=>!!data.players?.[pid]?.faction).length;
  if(picked!==2) return toast("ì§„ì˜ ì„ íƒ í•„ìš”");

  data.status="playing";
  data.turnOwner=ps[Math.floor(Math.random()*2)];
  ensureTurnStart(data);
  await setDoc(ref,data);

  // ê²Œì„ í™”ë©´ ì§„ì… ì‹œ ê¸°ë³¸ ëª¨ë“œ
  setMode("buy");
};

/* ===== Game buttons ===== */
$("modeBuy").onclick=()=>setMode("buy");
$("modeSummon").onclick=()=>setMode("summon");
$("modeAttack").onclick=()=>setMode("attack");
$("buy").onclick=buyCard;
$("endTurn").onclick=endTurn;

/* ===== init ===== */
setConn("OFF");
bindPlayerAttackZones();
</script>
</body>
</html>
