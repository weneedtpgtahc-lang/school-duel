<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ğŸ”´ ë„ˆ Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ ì„¤ì •ì„ ê·¸ëŒ€ë¡œ ë„£ì–´ */
const firebaseConfig = {
  apiKey: "ì—¬ê¸°",
  authDomain: "ì—¬ê¸°",
  projectId: "ì—¬ê¸°",
  storageBucket: "ì—¬ê¸°",
  messagingSenderId: "ì—¬ê¸°",
  appId: "ì—¬ê¸°",
  measurementId: "ì—¬ê¸°(ìˆìœ¼ë©´)"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const $ = (id) => document.getElementById(id);

const me = crypto.randomUUID();
let room = null;
let unsub = null;

function listen(){
  if (!room) return;
  if (unsub) unsub();

  unsub = onSnapshot(doc(db, "rooms", room), (snap) => {
    if (!snap.exists()) {
      $("state").textContent = "ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ";
      return;
    }
    $("state").textContent = JSON.stringify(snap.data(), null, 2);
  }, (err) => {
    $("state").textContent = "ì—ëŸ¬: " + err.message;
  });
}

async function loadRoom(){
  if (!room) throw new Error("ë°© ì½”ë“œê°€ ì—†ìŒ");
  const ref = doc(db, "rooms", room);
  const snap = await getDoc(ref);
  if (!snap.exists()) throw new Error("ë°©ì´ ì—†ìŒ");
  return { ref, data: snap.data() };
}

/* âœ… ë°© ë§Œë“¤ê¸°: rooms/{code} êµ¬ì¡°ë¥¼ ìš°ë¦¬ê°€ ì“°ëŠ” í˜•íƒœë¡œ ìƒì„± */
$("create").onclick = async () => {
  room = Math.random().toString(36).slice(2, 8).toUpperCase();

  await setDoc(doc(db, "rooms", room), {
    status: "lobby",
    turn: 1,
    turnOwner: null,       // ë‚˜ì¤‘ì— 2ëª… ëª¨ì´ë©´ ì„ ê³µ ì§€ì •
    actionLeft: 2,         // í„´ë‹¹ ì¹´ë“œ ì‚¬ìš© ê°€ëŠ¥ íšŸìˆ˜(ê¸°ë³¸ 2)
    players: {},           // ì°¸ê°€ ì‹œ ì±„ì›€
    lock: {},              // ì£½ì€ ì¹¸ ì ê¸ˆ(ë‹¤ìŒ ë‚´ í„´ê¹Œì§€)
    createdAt: serverTimestamp()
  });

  $("code").value = room;
  $("info").textContent = "ë°©: " + room;
  listen();
};

/* âœ… ë°© ì°¸ê°€ */
$("join").onclick = () => {
  room = $("code").value.trim().toUpperCase();
  $("info").textContent = "ë°©: " + room;
  listen();
};

/* âœ… ì§„ì˜ ì„ íƒ: players[me]ì— field[4], mana í¬í•¨í•´ì„œ ì €ì¥ */
$("virus").onclick = async () => {
  const { ref, data } = await loadRoom();
  data.players = data.players || {};

  data.players[me] = {
    faction: "virus",
    hp: 100,
    mana: 0,
    field: [null, null, null, null]
  };

  // 2ëª… ëª¨ì´ë©´ playingìœ¼ë¡œ ì „í™˜(ê°„ë‹¨ ë²„ì „)
  if (Object.keys(data.players).length >= 2) data.status = "playing";

  await setDoc(ref, data);
};

$("vaccine").onclick = async () => {
  const { ref, data } = await loadRoom();
  data.players = data.players || {};

  data.players[me] = {
    faction: "vaccine",
    hp: 100,
    mana: 0,
    field: [null, null, null, null]
  };

  if (Object.keys(data.players).length >= 2) data.status = "playing";

  await setDoc(ref, data);
};
</script>
